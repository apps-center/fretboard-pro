<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fretboard Pro</title>
  <style>
    *{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

/* --- Layout g√©n√©ral --- */

body{
  background:#0d0d0d;
  color:#eee;
  font-family:system-ui,sans-serif;
}

.app{
  max-width:1200px;
  margin:30px auto;
  padding:25px;
  background:rgba(20,20,35,0.95);
  border-radius:20px;
  backdrop-filter:blur(15px);
  box-shadow:0 20px 40px rgba(0,0,0,0.7);
}

h1{
  text-align:center;
  margin-bottom:20px;
  color:#4fc3f7;
  font-size:2rem;
}

/* --- Onglets Pop/Rock / Blues --- */

.tabs{
  display:flex;
  gap:12px;
  margin-bottom:20px;
  justify-content:center;
  flex-wrap:wrap;
}

.tab{
  padding:10px 22px;
  background:rgba(15,15,30,0.95);
  border:1px solid #333;
  border-radius:999px;
  color:#bbb;
  cursor:pointer;
  font-weight:600;
  font-size:0.95rem;
  letter-spacing:0.02em;
  transition:.25s;
}

.tab:hover{
  border-color:#4fc3f7;
  color:#fff;
}

.tab.active{
  background:linear-gradient(135deg,#4fc3f7,#00bcd4);
  color:#0b1020;
  border-color:transparent;
  box-shadow:0 4px 18px rgba(79,195,247,0.55);
}

/* --- Contenu des modes --- */

.mode{
  display:none;
  padding:15px;
  background:rgba(0,0,0,0.35);
  border-radius:12px;
  margin-bottom:15px;
}

.mode.active{
  display:block;
}

/* --- Inputs & boutons --- */

.inputs{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
  gap:10px;
  align-items:center;
  margin-bottom:10px;
}

.inputs input,
.inputs select,
.inputs input[type=number]{
  padding:11px 14px;
  background:#161626;
  border:1px solid #333;
  border-radius:12px;
  color:#f5f5f5;
  font-size:0.95rem;
  outline:none;
  min-width:0;
  transition:border-color .2s, box-shadow .2s, background .2s;
}

.inputs select{
  cursor:pointer;
}

.inputs input:focus,
.inputs select:focus{
  border-color:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
  background:#121222;
}

.inputs button{
  padding:11px 20px;
  background:linear-gradient(135deg,#4fc3f7,#00bcd4);
  border:none;
  border-radius:14px;
  color:#021018;
  font-weight:700;
  cursor:pointer;
  font-size:0.95rem;
  letter-spacing:0.03em;
  justify-self:flex-end;
  box-shadow:0 6px 18px rgba(0,0,0,0.7);
  transition:transform .15s, box-shadow .15s, filter .15s;
}

.inputs button:hover{
  filter:brightness(1.06);
  box-shadow:0 8px 22px rgba(0,0,0,0.8);
}

.inputs button:active{
  transform:translateY(1px);
  box-shadow:0 4px 14px rgba(0,0,0,0.6);
}

/* --- Options / cases √† cocher --- */

.options,
.common{
  display:flex;
  flex-wrap:wrap;
  gap:15px;
  align-items:center;
  margin:15px 0;
}

/* Zone commune : accord actuel / fret de d√©part / vue */
.options,
.common{
  display:flex;
  flex-wrap:wrap;
  gap:15px;
  align-items:center;
  margin:15px 0;
}

.options label,
.common label{
  font-size:0.95rem;
  color:#ddd;
}

/* Style des champs dans la zone commune */
.common label{
  display:flex;
  align-items:center;
  gap:8px;
}

/* Accord actuel + Fret de d√©part */
.common select,
.common input[type=number]{
  padding:8px 14px;
  background:#101020;
  border:1px solid #252545;
  border-radius:999px;
  color:#f5f5f5;
  font-size:0.9rem;
  min-width:70px;
  outline:none;
  transition:border-color .2s, box-shadow .2s, background .2s;
}

/* focus coh√©rent avec les boutons bleus */
.common select:focus,
.common input[type=number]:focus{
  border-color:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
  background:#121228;
}

/* retire les fl√®ches moches des input[type=number] (Chrome/Edge) */
.common input[type=number]::-webkit-outer-spin-button,
.common input[type=number]::-webkit-inner-spin-button{
  -webkit-appearance:none;
  margin:0;
}

/* Firefox */
.common input[type=number]{
  -moz-appearance:textfield;
}

/* --- Options Blues : checkboxes & select --- */

.options{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  margin:15px 0;
}

/* chaque option devient une petite "pill" sombre */
.options label{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  background:#101020;
  border-radius:999px;
  border:1px solid #252545;
  font-size:0.9rem;
  color:#ddd;
  cursor:pointer;
  user-select:none;
}

/* checkbox custom */
.options input[type=checkbox],
.common input[type=checkbox]{
  width:16px;
  height:16px;
  border-radius:4px;
  border:2px solid #4fc3f7;
  background:transparent;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  display:inline-block;
  position:relative;
  cursor:pointer;
  outline:none;
  transition:background .2s, box-shadow .2s, border-color .2s;
}

.options input[type=checkbox]:checked,
.common input[type=checkbox]:checked{
  background:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
}

.options input[type=checkbox]:checked::after,
.common input[type=checkbox]:checked::after{
  content:"";
  position:absolute;
  left:3px;
  top:0px;
  width:6px;
  height:10px;
  border-right:2px solid #021018;
  border-bottom:2px solid #021018;
  transform:rotate(40deg);
}


/* le select "Style" dans la m√™me logique que les champs communs */
.options select{
  padding:6px 14px;
  background:#101020;
  border:1px solid #252545;
  border-radius:999px;
  color:#f5f5f5;
  font-size:0.9rem;
  outline:none;
  min-width:110px;
  cursor:pointer;
  transition:border-color .2s, box-shadow .2s, background .2s;
}

.options select:focus{
  border-color:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
  background:#121228;
}


.options label,
.common label{
  font-size:0.95rem;
  color:#ddd;
}

/* --- Boutons de choix (par ex. 5 frettes / 15 frettes) --- */

.view-toggle{
  display:inline-flex;
  align-items:center;
  gap:4px;
  background:#101020;
  border-radius:999px;
  padding:4px;
  border:1px solid #252545;
  margin:10px 0 18px;
}

.view-toggle button{
  border:none;
  background:transparent;
  padding:6px 14px;
  border-radius:999px;
  font-size:0.85rem;
  color:#aaa;
  cursor:pointer;
  transition:.2s;
  white-space:nowrap;
}

.view-toggle button:hover{
  color:#fff;
}

.view-toggle button.active{
  background:linear-gradient(135deg,#4fc3f7,#00bcd4);
  color:#021018;
  box-shadow:0 4px 12px rgba(79,195,247,0.5);
}

/* --- L√©gende --- */

.legend{
  display:flex;
  flex-wrap:nowrap;      /* toutes les notes sur une seule ligne */
  gap:26px;
  margin:20px 0;
  overflow-x:auto;
  padding-bottom:4px;
}

.legend::-webkit-scrollbar{
  height:6px;
}
.legend::-webkit-scrollbar-track{
  background:transparent;
}
.legend::-webkit-scrollbar-thumb{
  background:#333;
  border-radius:999px;
}

.legend span{
  display:flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
  font-size:0.9rem;
}

.dot{
  width:16px;
  height:16px;
  border-radius:50%;
  display:inline-block;
}

.dot.chord{background:#aaa}
.dot.root{
  background:#ffeb3b;
  animation:pulse 2s infinite;
}
.dot.target{background:#ff9800}
.dot.avoid{background:#e53935}
.dot.ok{background:#8bc34a}
.dot.blues{background:#2196f3}
.dot.penta-minor{background:#9c27b0}
.dot.penta-major{background:#ff5722}

/* --- Manche de guitare --- */

.fretboard{
  background:rgba(0,0,0,0.5);
  padding:25px;
  border-radius:16px;

  /* r√©duction d‚Äôenviron 15% */
  transform:scale(0.85);
  transform-origin:top center;
  margin:0 auto; /* bien centr√© apr√®s le scale */
}


#fb{
  display:grid;
  grid-template-rows:repeat(6,70px);
  gap:4px;
  background:#111;
  border-radius:12px;
  overflow:hidden;
  padding:10px;
  position:relative;
}

/* 6 cordes dessin√©es sur tout le manche */
#fb::before{
  content:"";
  position:absolute;
  left:10px;
  right:10px;
  top:10px;
  bottom:10px;
  pointer-events:none;

  /* 6 lignes horizontales espac√©es r√©guli√®rement */
  background-image:
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555);
  background-repeat:no-repeat;
  background-size:100% 3px;  /* √©paisseur de la corde */
  background-position:
    0 calc(100% * 1/12),
    0 calc(100% * 3/12),
    0 calc(100% * 5/12),
    0 calc(100% * 7/12),
    0 calc(100% * 9/12),
    0 calc(100% * 11/12);
}


/* cases du manche */
.cell{
  position:relative;
  background:transparent;              /* ne masque plus les cordes */
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:default;
  box-shadow:inset 0 0 0 1px #1a1a1a;  /* pour garder les ‚Äúcases‚Äù visibles */
}



/* Barre de frette pour toutes les colonnes marqu√©es .fret */
.cell.fret::after{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  left:50%;
  width:6px;
  background:#888;
  transform:translateX(-50%);
  z-index:1;
}

/* Sillet (frette 0) un peu plus √©pais sur le bord gauche */
.cell.nut::after{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  left:0;
  width:8px;
  background:#aaa;
  z-index:1;
}


/* --- Notes sur le manche --- */

.note{
  width:44px;
  height:44px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:#000;
  background:#333; /* fallback */
  box-shadow:0 4px 15px rgba(0,0,0,0.7);
  position:relative;
  z-index:2;
  transition:transform .15s, box-shadow .15s, background .15s;
  font-size:0.9rem;
}

.note:hover{
  transform:translateY(-1px) scale(1.03);
  box-shadow:0 6px 18px rgba(0,0,0,0.9);
}

/* Tonique en plus gros */
.note.root{
  width:56px;
  height:56px;
  font-size:1.1rem;
  background:#ffeb3b;
  color:#000;
  animation:pulse 2s infinite;
}

/* R√¥le des notes */
.note.chord{
  background:#aaa;
  color:#000;
}

.note.target{
  background:#ff9800;
  color:#000;
}

.note.ok{
  background:#8bc34a;
  color:#000;
}

.note.blues{
  background:#2196f3;
  color:#fff;
}

.note.penta-minor{
  background:#9c27b0;
  color:#fff;
}

.note.penta-major{
  background:#ff5722;
  color:#fff;
}

/* Optionnel : si tu d√©cides d‚Äôafficher les notes √† √©viter */
.note.avoid{
  background:#e53935;
  color:#fff;
  opacity:0.75;
}

/* --- Labels de frettes --- */

#labels{
  display:flex;
  justify-content:space-between;
  margin-top:12px;
  font-size:0.95rem;
  color:#aaa;
  padding:0 15px;
}

/* --- Message d‚Äôinfo / tonalit√© --- */

.msg{
  font-weight:600;
  color:#4fc3f7;
  margin-top:10px;
}

/* --- Animation pulsation (tonique) --- */

@keyframes pulse{
  0%,100%{box-shadow:0 0 15px #ffeb3b}
  50%{box-shadow:0 0 25px #ffeb3b}
}

/* Tablette */
@media (max-width: 768px) {
  .app{
    margin:10px;
    padding:18px;
  }

  h1{
    font-size:1.6rem;
  }

  .fretboard{
    padding:18px;
    transform:scale(0.8);
  }

  #fb{
    grid-template-rows:repeat(6, 55px); /* moins haut */
  }
}

/* Petit smartphone */
@media (max-width: 480px) {
  .app{
    margin:6px;
    padding:14px;
    border-radius:12px;
  }

  h1{
    font-size:1.3rem;
  }

  .inputs{
    grid-template-columns:1fr; /* 1 colonne pour les accords + bouton */
  }

  .common{
    flex-direction:column;
    align-items:flex-start;
  }

  .fretboard{
    padding:12px;
    transform:scale(0.75);
  }

  #fb{
    grid-template-rows:repeat(6, 45px);
  }

  .note{
    width:38px;
    height:38px;
    font-size:0.8rem;
  }

  .note.root{
    width:48px;
    height:48px;
    font-size:0.95rem;
  }
}

/* Smartphone portrait */
@media (max-width: 480px) {

  .fretboard{
    padding: 10px;
    transform: none;          /* on enl√®ve le scale fixe */
    margin: 0 auto;
    width: 100%;
  }

  #fb{
    padding: 6px;
    grid-template-rows: repeat(6, 42px); /* hauteur r√©duite */
    gap: 3px;
  }

  /* Cases plus compactes */
  .cell{
    box-shadow: inset 0 0 0 1px #222;
  }

  /* Notes plus petites mais lisibles */
  .note{
    width: 34px;
    height: 34px;
    font-size: 0.75rem;
  }

  .note.root{
    width: 44px;
    height: 44px;
    font-size: 0.9rem;
  }

  /* Labels du bas */
  #labels{
    font-size: 0.8rem;
    padding: 0 8px;
    margin-top: 8px;
  }

  /* Contours / inlays plus fins */
  .cell.fret::after{
    width: 4px;
  }

  .cell.nut::after{
    width: 6px;
  }
}

  </style>
</head>
<body>
  <main class="app">
    <h1>Fretboard Pro</h1>

    <!-- Onglets principaux -->
    <div class="tabs">
      <button class="tab active" data-mode="pop">Pop/Rock</button>
      <button class="tab" data-mode="blues">Blues</button>
    </div>

    <!-- === MODE POP/ROCK === -->
    <div id="popMode" class="mode active">
      <div class="inputs">
        <!-- 4 accords (menus d√©roulants) -->
        <select id="chord1"></select>
        <select id="chord2"></select>
        <select id="chord3"></select>
        <select id="chord4"></select>

        <!-- Bouton : d√©tection de tonalit√© -->
        <button id="findKey">Trouver la tonalit√©</button>

        <!-- Nouveau : g√©n√©ration automatique -->
        <select id="progressionStyle">
          <option value="pop">Pop</option>
          <option value="rock">Rock</option>
          <option value="funk">Funk</option>
        </select>

        <select id="progressionLength">
          <option value="2">2 accords</option>
          <option value="4" selected>4 accords</option>
        </select>

        <button id="generateProg">G√©n√©rer une suite</button>
      </div>

      <p id="popResult" class="msg"></p>
    </div>

    <!-- === MODE BLUES === -->
    <div id="bluesMode" class="mode">
      <div class="inputs">
        <label>
          Tonalit√© :
          <select id="bluesKey">
            <option>E</option>
            <option selected>A</option>
            <option>D</option>
            <option>G</option>
            <option>C</option>
            <option>F</option>
            <option>Bb</option>
            <option>Eb</option>
            <option>Ab</option>
            <option>Db</option>
            <option>Gb</option>
            <option>B</option>
          </select>
        </label>
        <span id="bluesGrid" class="msg"></span>
      </div>

      <div class="options">
        <label><input type="checkbox" id="pentaMin" checked> Penta min</label>
        <label><input type="checkbox" id="pentaMaj"> Penta maj</label>
        <label><input type="checkbox" id="bluesNotes" checked> Notes blues</label>
        <label>
          Style :
          <select id="bluesStyle">
            <option value="standard">Standard</option>
            <option value="slow">Slow Blues</option>
          </select>
        </label>
      </div>
    </div>

        <!-- === Zone commune (accord courant / fret / vue) === -->
    <div class="common">
      <label>
        Accord actuel :
        <select id="chordSel"></select>
      </label>

      <label>
        Fret de d√©part :
        <input id="startFret" type="number" min="0" max="12" value="5">
      </label>

      <!-- Choix 5 frettes / 15 frettes -->
      <div class="view-toggle">
        <button type="button" data-frets="5" class="active">5 frettes</button>
        <button type="button" data-frets="10">10 frettes</button>
        <button type="button" data-frets="15">15 frettes</button>
      </div>

      <!-- ‚úÖ case pour afficher la blue note -->
      <label>
        <input type="checkbox" id="showBlueNote">
        Note blue (b5)
      </label>
    </div>


    <!-- L√©gende (toutes les notes sur une ligne, g√©r√© par le CSS) -->
    <div class="legend">
      <span><i class="dot chord"></i>Accord (tonique en gros)</span>
      <span><i class="dot root"></i>Tonique</span>
      <span><i class="dot target"></i>Cible (slow blues)</span>
      <span><i class="dot avoid"></i>√Ä √©viter</span>
      <span><i class="dot ok"></i>Dans la gamme</span>
      <span><i class="dot blues"></i>Note blues</span>
      <span><i class="dot penta-minor"></i>Penta min</span>
      <span><i class="dot penta-major"></i>Penta maj</span>
    </div>

    <!-- Manche -->
    <div class="fretboard">
      <div id="fb"></div>
      <div id="labels"></div>
    </div>
  </main>

  <script>
    // ================== CONSTANTES & UTILITAIRES ==================

const NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const STRINGS = ["E","B","G","D","A","E"]; // de la plus grave √† la plus aigu√´

// Liste compl√®te des accords de base (chromatisme + variantes)
const CHORD_LIST = [
  "C","C#","D","D#","E","F","F#","G","G#","A","A#","B",
  "Cm","C#m","Dm","D#m","Em","Fm","F#m","Gm","G#m","Am","A#m","Bm",
  "C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7",
  "Cm7","C#m7","Dm7","D#m7","Em7","Fm7","F#m7","Gm7","G#m7","Am7","A#m7","Bm7",
  "Cdim","C#dim","Ddim","D#dim","Edim","Fdim","F#dim","Gdim","G#dim","Adim","A#dim","Bdim"
];

// Rempli les 4 menus d'accords du mode Pop/Rock
function populateChordDropdowns(){
  ["chord1","chord2","chord3","chord4"].forEach((id, idx) => {
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.innerHTML = "";
    CHORD_LIST.forEach(ch => sel.add(new Option(ch, ch)));
    // Valeurs par d√©faut : C / G / Am / F
    const defaults = ["C","G","Am","F"];
    sel.value = defaults[idx];
  });
}


// nombre de frettes affich√©es (pilot√© par les boutons 5 / 10 / 15)
let fretCount = 5;

let useFlats = false;          // gestion # / b (pour plus tard)
let currentKeyRoot = 0;        // racine de la tonalit√© courante en mode Pop/Rock

const MODE_NAMES = ["ionian","dorian","phrygian","lydian","mixolydian","aeolian","locrian"];

// Mod√®les de suites d'accords diatoniques (en degr√©s de gamme majeure)
const PROG_TEMPLATES = {
  pop: {
    2: [
      [1, 5], // I - V
      [6, 4], // vi - IV
      [4, 5]  // IV - V
    ],
    4: [
      [1, 5, 6, 4], // I - V - vi - IV (ultra classique)
      [6, 4, 1, 5], // vi - IV - I - V
      [1, 6, 4, 5], // I - vi - IV - V
      [1, 4, 5, 4]  // I - IV - V - IV
    ]
  },
  rock: {
    2: [
      [1, 4], // I - IV
      [1, 5], // I - V
      [5, 4]  // V - IV
    ],
    4: [
      [1, 4, 5, 4], // I - IV - V - IV
      [1, 5, 4, 5], // I - V - IV - V
      [2, 5, 1, 1], // ii - V - I - I
      [5, 4, 1, 1]  // V - IV - I - I
    ]
  },
  funk: {
    2: [
      [2, 5], // ii - V
      [1, 2]  // I - ii
    ],
    4: [
      [2, 5, 1, 1], // ii - V - I - I
      [2, 5, 6, 6], // ii - V - vi - vi
      [1, 2, 5, 4]  // I - ii - V - IV
    ]
  }
};

// Construit le nom d'accord diatonique (en gamme majeure) pour un degr√© donn√©
function getDiatonicChordName(rootIndex, degree, style = "pop"){
  const scale = majorScale(rootIndex);           // degr√©s 1‚Äì7 en notes
  const noteRoot = scale[degree - 1];            // 0 ‚Üí I, 1 ‚Üí II, etc.
  const noteName = i2n(noteRoot);                // "C", "D", "E", ...

  // Pour le funk, on met un peu plus de 7e
  if(style === "funk"){
    if(degree === 2 || degree === 3 || degree === 6){
      return noteName + "m7";   // ii m7, iii m7, vi m7
    }
    if(degree === 5){
      return noteName + "7";    // V7
    }
    // I, IV, VII : on reste sur triades diatoniques
  }

  // Qualit√© de triade diatonique en gamme MAJEURE : M, m, dim
  const quality = MAJOR_DEG_QUALITIES[degree - 1];

  if(quality === "m")   return noteName + "m";
  if(quality === "dim") return noteName + "dim";
  return noteName; // majeur
}

function generateDiatonicProgression(){
  const styleSel   = document.getElementById("progressionStyle");
  const lengthSel  = document.getElementById("progressionLength");
  const resultEl   = document.getElementById("popResult");

  const style  = styleSel ? styleSel.value : "pop";
  const length = lengthSel ? parseInt(lengthSel.value, 10) || 4 : 4;

  const templatesByLen = PROG_TEMPLATES[style]?.[length];
  if(!templatesByLen || !templatesByLen.length){
    console.warn("Pas de mod√®le pour ce style/longueur");
    return;
  }

  // Choix d'un mod√®le au hasard parmi ceux disponibles
  const basePattern = templatesByLen[Math.floor(Math.random() * templatesByLen.length)];

  // Si l'utilisateur a demand√© "2 accords", on les r√©p√®te pour remplir les 4 cases
  const fullPattern = (basePattern.length === 2)
    ? basePattern.concat(basePattern)  // ex. [1,5] -> [1,5,1,5]
    : basePattern;

  // Choix d'une tonalit√© majeure au hasard (pour varier un peu)
  const randomRoot = Math.floor(Math.random() * 12); // 0‚Äì11
  currentKeyRoot = randomRoot;                       // pour le manche
  const keyName = i2n(randomRoot);

  // Conversion des degr√©s en noms d'accords
  const chords = fullPattern.map(deg =>
    getDiatonicChordName(randomRoot, deg, style)
  );

  // Remplit les 4 s√©lecteurs d'accords
  const ids = ["chord1","chord2","chord3","chord4"];
  ids.forEach((id, idx) => {
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.value = chords[idx] || chords[0];
  });

  // Met √† jour la liste d√©roulante "Accord actuel"
  initPopChordSelect();

  // Message d'info
  if(resultEl){
    resultEl.textContent =
      `Suite g√©n√©r√©e : ${chords.join(" - ")} (en ${keyName} majeur, style ${style})`;
  }

  // Rafra√Æchit le manche
  render();
}


function n2i(note){
  note = note.replace("‚ôØ","#").replace("‚ô≠","b");
  if(note.length === 2 && note[1] === "b") {
    return NOTES_FLAT.indexOf(note);
  }
  return NOTES_SHARP.indexOf(note.toUpperCase());
}

function i2n(index){
  return useFlats ? NOTES_FLAT[index % 12] : NOTES_SHARP[index % 12];
}

function parseChord(str){
  str = str.trim();
  const match = str.match(/^([A-G][b#]?)(.*)/i);
  if(!match) {
    return {
      root: 0,
      name: str,
      minor: false,
      dominant7: false,
      dim: false
    };
  }

  const root = match[1];
  const suffix = match[2].toLowerCase();

  // diminu√© (B¬∞, Bdim, Bo‚Ä¶)
  const dim = /dim|¬∞|o/.test(suffix);

  // mineur : m, min, -  (mais PAS maj)
  let minor = false;
  if(!dim){
    if(/^m(?!aj)/.test(suffix) || /min/.test(suffix) || /-/.test(suffix)){
      minor = true;
    }
  }

  // 7 de dominante (A7, D7‚Ä¶) ‚Äì mais pas maj7, ni m7
  const dominant7 = /7/.test(suffix) && !minor && !/maj7/.test(suffix);

  return {
    root: n2i(root),
    name: str,
    minor,
    dominant7,
    dim
  };
}


function majorScale(r){ return [0,2,4,5,7,9,11].map(d => (r+d)%12); }
function pentaMin(r){ return [0,3,5,7,10].map(d => (r+d)%12); }
function pentaMaj(r){ return [0,2,4,7,9].map(d => (r+d)%12); }

// Gamme mineure naturelle (pour tonalit√©s mineures)
function minorScale(r){ return [0,2,3,5,7,8,10].map(d => (r+d)%12); }

// Qualit√© attendue des triades dans la gamme MAJEURE : I ii iii IV V vi vii¬∞
const MAJOR_DEG_QUALITIES = ["M","m","m","M","M","m","dim"];

// Qualit√© attendue des triades dans la gamme MINEURE naturelle : i ii¬∞ III iv v VI VII
const MINOR_DEG_QUALITIES = ["m","dim","M","m","m","M","M"];

// Qualit√© de triade √† partir de l'accord pars√©
function triadQualityFromChord(ch){
  if(ch.dim) return "dim";
  if(ch.minor) return "m";
  return "M";
}

// Score d'une tonalit√© (majeure ou mineure) pour une liste d'accords
function scoreDiatonicKey(chords, keyRoot, isMajor = true){
  const scale = isMajor ? majorScale(keyRoot) : minorScale(keyRoot);
  const qualities = isMajor ? MAJOR_DEG_QUALITIES : MINOR_DEG_QUALITIES;

  let score = 0;
  let explained = 0;

  chords.forEach(ch => {
    const idx = scale.indexOf(ch.root);
    if(idx === -1){
      // accord compl√®tement hors de la gamme ‚Üí grosse p√©nalit√©
      score -= 2;
      return;
    }

    explained++;

    const expected = qualities[idx];      // M / m / dim
    const actual = triadQualityFromChord(ch);

    if(actual === expected){
      // accord exactement diatonique au bon degr√©
      score += 5;
    } else if(expected === "dim" && actual === "m"){
      // mineur l√† o√π on attendait diminu√© : pas parfait, mais proche
      score -= 1;
    } else {
      // majeur au lieu de mineur ou l'inverse ‚Üí grosse p√©nalit√©
      score -= 3;
    }

    // bonus pour I / IV / V en majeur, i / iv / v en mineur
    const isTonicDegree    = (idx === 0);
    const isSubdominant    = (idx === 3);
    const isDominant       = (idx === 4);

    if(!ch.dim){
      if(isMajor && !ch.minor && (isTonicDegree || isSubdominant || isDominant)){
        score += 2;
      }
      if(!isMajor && ch.minor && (isTonicDegree || isSubdominant || isDominant)){
        score += 2;
      }
    }
  });

  // bonus si on a clairement l'accord de tonique dans la bonne qualit√©
  const tonicChord = chords.find(ch =>
    ch.root === keyRoot &&
    ((isMajor && !ch.minor && !ch.dim) || (!isMajor && ch.minor && !ch.dim))
  );
  if(tonicChord) score += 3;

  return {score, explained};
}


// Renvoie le nom du mode (ionian, dorian, ...) pour un accord diatonique
function getModeNameForChord(chordRoot, keyRoot){
  const scale = majorScale(keyRoot);
  const idx = scale.indexOf(chordRoot);
  if(idx === -1) return null;
  return MODE_NAMES[idx] || null;
}

// ================== RENDU DU MANCHE ==================

function render(){
  const fb = document.getElementById("fb");
  const labels = document.getElementById("labels");
  const startFret = parseInt(document.getElementById("startFret").value) || 0;

  // --- centrage du "pattern principal" (box de pentatonique) ---
  const patternWidth = 5; // startFret -> startFret + 4
  const extra = Math.max(fretCount - patternWidth, 0);
  const extraBefore = Math.floor(extra / 2);
  const extraAfter = extra - extraBefore; // si besoin plus tard

  let firstFret = startFret - extraBefore;
  if (firstFret < 0) firstFret = 0;

  fb.innerHTML = "";
  labels.innerHTML = "";
  fb.style.gridTemplateColumns = `repeat(${fretCount}, 1fr)`;

  const isBluesMode = document.querySelector(".tab.active").dataset.mode === "blues";

  // racine de tonalit√©
  const keyRoot = isBluesMode
    ? n2i(document.getElementById("bluesKey").value)
    : currentKeyRoot;

  const scaleSet = isBluesMode
    ? new Set(pentaMin(keyRoot)) // en blues on se base sur penta min de la TONALIT√â
    : new Set(majorScale(keyRoot));

  // accord s√©lectionn√©
  const selectedChordText = document.getElementById("chordSel").value || "C";
  const chord = parseChord(selectedChordText);

  // notes de l'accord
  const chordNotes = new Set([chord.root]);
  const thirdInterval = (chord.dim || chord.minor) ? 3 : 4;
  const fifthInterval = chord.dim ? 6 : 7;

  chordNotes.add((chord.root + thirdInterval) % 12); // tierce
  chordNotes.add((chord.root + fifthInterval) % 12); // quinte

  if(chord.dominant7 || (chord.minor && /7/.test(chord.name))) {
    chordNotes.add((chord.root + 10) % 12);          // septi√®me mineure
  }

  // Quel mode correspond √† cet accord (dans la tonalit√© majeure trouv√©e) ?
  let modeName = null;
  if(!isBluesMode){
    modeName = getModeNameForChord(chord.root, keyRoot); // ionian / dorian / ...
  }

  // === PENTAS & NOTES BLUES ===
  // ‚Üí UNIQUEMENT actives en mode BLUES et si coch√©es.
    const pentaMinCb   = document.getElementById("pentaMin");
    const pentaMajCb   = document.getElementById("pentaMaj");
    const bluesNotesCb = document.getElementById("bluesNotes");
    const globalBlueCb = document.getElementById("showBlueNote");

    const showPentaMin   = isBluesMode && (pentaMinCb?.checked ?? false);
    const showPentaMaj   = isBluesMode && (pentaMajCb?.checked ?? false);
    const showBluesNotes = isBluesMode && (bluesNotesCb?.checked ?? false);

    const pentaMinSet = showPentaMin ? new Set(pentaMin(chord.root)) : new Set();
    const pentaMajSet = showPentaMaj ? new Set(pentaMaj(chord.root)) : new Set();

    // Blue note typique (b5) de l'accord
    const bluesNote = (chord.root + 6) % 12;

    // üëâ en Blues : checkbox "Notes blues"
    // üëâ en Pop/Rock : checkbox globale "Note blue (b5)"
    const showBlue =
      (isBluesMode && showBluesNotes) ||
      (!isBluesMode && (globalBlueCb?.checked ?? false));

    const bluesSet = showBlue ? new Set([bluesNote]) : new Set();

    const slowBlues = document.getElementById("bluesStyle")?.value === "slow";


  // --- Rendu du manche ---
  STRINGS.forEach(openString => {
    const openNoteIdx = n2i(openString);

    for(let f = 0; f < fretCount; f++){
      const fretNum = firstFret + f;
      const noteIdx = (openNoteIdx + fretNum) % 12;

      const cell = document.createElement("div");
      cell.className = "cell";

      // sillet uniquement si on affiche r√©ellement la frette 0
      if(fretNum === 0){
        cell.classList.add("nut");
      } else {
        cell.classList.add("fret");
      }

      // rep√®res (inlays)
      if([3,5,7,9,15,17,19,21].includes(fretNum)) cell.classList.add("inlay");
      if(fretNum === 12) cell.classList.add("double-inlay");

            let role;
      const intervalFromRoot = (noteIdx - chord.root + 12) % 12;

      // pour classifier dynamiquement cible / √† √©viter :
      const chordToneArray = [...chordNotes];
      const isHalfStepBelowChord = chordToneArray.some(c => (noteIdx + 1) % 12 === c);   // note = -1
      const isHalfStepAboveChord = chordToneArray.some(c => (noteIdx + 11) % 12 === c);  // note = +1

      if(noteIdx === chord.root) {
        role = "root";

      } else if(chordNotes.has(noteIdx)) {
        role = "chord";

      } else if(pentaMinSet.has(noteIdx)) {
        role = "penta-minor";

      } else if(pentaMajSet.has(noteIdx)) {
        role = "penta-major";

      } else if(bluesSet.has(noteIdx)) {
        role = "blues";

      } else if(isBluesMode && slowBlues && [2,5,9].includes(intervalFromRoot)) {
        // notes cibles typiques slow blues (2nd, 4th, 6th)
        role = "target";

      } else if(!isBluesMode && scaleSet.has(noteIdx)) {
        // POP/ROCK : note dans la gamme ‚Üí on applique la logique 1/2 ton
        if(isHalfStepBelowChord) {
          // demi-ton en dessous d'une note d'accord ‚Üí note cible
          role = "target";
        } else if(isHalfStepAboveChord) {
          // demi-ton au-dessus d'une note d'accord ‚Üí note √† √©viter
          role = "avoid";
        } else {
          // dans la gamme mais pas sp√©cialement tendue
          role = "ok";
        }

      } else if(scaleSet.has(noteIdx)) {
        // BLUES (ou cas restant) : note correcte de la gamme
        role = "ok";

      } else {
        // Note hors gamme ‚Üí on ne l'affiche pas
        role = null;
      }


      if(role){
        const dot = document.createElement("div");
        dot.className = `note ${role}`;
        if(role === "root") dot.classList.add("root");
        dot.textContent = i2n(openNoteIdx + fretNum);
        cell.appendChild(dot);
      }

      fb.appendChild(cell);
    }
  });

  // --- Labels de frettes ---
  for(let i = 0; i < fretCount; i++){
    const num = firstFret + i;

    const div = document.createElement("div");
    div.textContent = num;

    if([3,5,7,9,12,15].includes(num)) div.style.fontWeight = "bold";
    if(num === 12) div.style.color = "#ffeb3b";

    labels.appendChild(div);
  }
}

// ================== INIT SELECT D'ACCORD POP ==================

populateChordDropdowns();

function initPopChordSelect(){
  const sel = document.getElementById("chordSel");
  if(!sel) return;
  sel.innerHTML = "";
  ["chord1","chord2","chord3","chord4"].forEach(id => {
    const v = document.getElementById(id)?.value.trim();
    if(v) sel.add(new Option(v));
  });
}

// ================== GESTION DES VUES 5 / 10 / 15 FRETTES ==================

const viewButtons = document.querySelectorAll(".view-toggle button");

function setFretsFromButton(btn){
  if(!btn) return;
  const frets = parseInt(btn.dataset.frets, 10) || 15;
  fretCount = frets;
  viewButtons.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  render();
}

viewButtons.forEach(btn => {
  btn.addEventListener("click", () => setFretsFromButton(btn));
});

// ================== GESTION DES ONGLETS ==================

document.querySelectorAll(".tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".tab, .mode").forEach(el => el.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.mode + "Mode").classList.add("active");

    const sel = document.getElementById("chordSel");

    if(tab.dataset.mode === "blues"){
      // accords I / IV / V dans la tonalit√© choisie
      const key = document.getElementById("bluesKey").value;
      const keyRoot = n2i(key);
      const IV = i2n(keyRoot + 5);
      const V = i2n(keyRoot + 7);

      const chordsForGrid = [`${key}7`, `${IV}7`, `${V}7`];
      document.getElementById("bluesGrid").textContent = "Grille : " + chordsForGrid.join(" - ");

      if(sel){
        sel.innerHTML = "";
        [`${key}7 (I)`, `${IV}7 (IV)`, `${V}7 (V)`].forEach(c => sel.add(new Option(c)));
      }
    } else {
      // mode Pop/Rock ‚Üí on reprend les accords saisis
      initPopChordSelect();
    }

    render();
  };
});

// ================== TROUVER LA TONALIT√â POP/ROCK ==================

document.getElementById("findKey").onclick = () => {
  const inputs = ["chord1","chord2","chord3","chord4"]
    .map(id => document.getElementById(id).value.trim())
    .filter(Boolean);

  if(inputs.length < 2) {
    alert("Entrez au moins 2 accords");
    return;
  }

  const parsed = inputs.map(parseChord);
  const candidates = [];

  // On teste les 12 tonalit√©s MAJEURES et MINEURES
  for(let r = 0; r < 12; r++){
    // MAJEUR
    const maj = scoreDiatonicKey(parsed, r, true);
    if(maj.explained >= 2){
      candidates.push({
        key: i2n(r),
        mode: "majeur",
        score: maj.score,
        explained: maj.explained
      });
    }

    // MINEUR (gamme mineure naturelle)
    const min = scoreDiatonicKey(parsed, r, false);
    if(min.explained >= 2){
      candidates.push({
        key: i2n(r) + "m",
        mode: "mineur",
        score: min.score,
        explained: min.explained
      });
    }
  }

  // on trie : meilleur score, puis plus d'accords expliqu√©s, puis majeur avant mineur
  candidates.sort((a, b) => {
    if(b.score !== a.score) return b.score - a.score;
    if(b.explained !== a.explained) return b.explained - a.explained;
    if(a.mode !== b.mode) return a.mode === "majeur" ? -1 : 1;
    return 0;
  });

  const best = candidates[0];
  const resultEl = document.getElementById("popResult");

  if(best){
    resultEl.textContent =
      `Tonalit√© probable : ${best.key} (${best.mode}) ‚Äì ` +
      `${best.explained}/${inputs.length} accords expliqu√©s`;

    // on garde la racine MAJEURE pour l'affichage du manche
    currentKeyRoot = n2i(best.key.replace("m",""));

    const sel = document.getElementById("chordSel");
    if(sel){
      sel.innerHTML = "";
      inputs.forEach(ch => sel.add(new Option(ch)));
    }
  } else {
    resultEl.textContent = "Aucune tonalit√© claire d√©tect√©e";
  }

  render();
};


// ================== AUTRES √âCOUTEURS ==================

["pentaMin","pentaMaj","bluesNotes","bluesStyle","startFret","chordSel","showBlueNote"]
  .forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener("change", render);
  });


// changement de tonalit√© blues ‚Üí met √† jour la grille et les accords
const bluesKeySelect = document.getElementById("bluesKey");
if(bluesKeySelect){
  bluesKeySelect.addEventListener("change", () => {
    const key = bluesKeySelect.value;
    const keyRoot = n2i(key);
    const IV = i2n(keyRoot + 5);
    const V = i2n(keyRoot + 7);

    const chordsForGrid = [`${key}7`, `${IV}7`, `${V}7`];
    document.getElementById("bluesGrid").textContent = "Grille : " + chordsForGrid.join(" - ");

    const sel = document.getElementById("chordSel");
    if(document.querySelector(".tab.active").dataset.mode === "blues" && sel){
      sel.innerHTML = "";
      [`${key}7 (I)`, `${IV}7 (IV)`, `${V}7 (V)`].forEach(c => sel.add(new Option(c)));
    }
    render();
  });
}

// ================== STYLE DES INLAYS ==================

const inlayStyle = document.createElement("style");
inlayStyle.textContent = `
  .inlay::before {
    content:"";
    position:absolute;
    width:12px;
    height:12px;
    background:#666;
    border-radius:50%;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:1;
  }
  .double-inlay::before {
    width:12px;
    height:36px;
    border-radius:8px;
    background:#888;
  }
`;
document.head.appendChild(inlayStyle);

// ================== INITIALISATION ==================

// accords init pour le mode Pop
initPopChordSelect();

// vue par d√©faut : 5 frettes pour TOUT (Pop & Blues)
const defaultBtn5 = document.querySelector('.view-toggle button[data-frets="5"]');
if(defaultBtn5) {
  setFretsFromButton(defaultBtn5);
} else {
  render();
}

// Bouton : g√©n√©ration automatique de suite d'accords diatoniques
const genBtn = document.getElementById("generateProg");
if(genBtn){
  genBtn.addEventListener("click", generateDiatonicProgression);
}

  </script>
</body>
</html>
