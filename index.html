<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fretboard Pro</title>
  <style>
  
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

/* --- Layout g√©n√©ral --- */

body{
  background:#0d0d0d;
  color:#eee;
  font-family:system-ui,sans-serif;
}

.app{
  max-width:1200px;
  margin:15px auto;         /* r√©duction de la marge */
  padding:15px;             /* r√©duction du padding */
  background:rgba(20,20,35,0.95);
  border-radius:20px;
  backdrop-filter:blur(15px);
  box-shadow:0 20px 40px rgba(0,0,0,0.7);
}

h1{
  text-align:center;
  margin-bottom:12px;       /* r√©duction de la marge */
  color:#4fc3f7;
  font-size:1.8rem;         /* r√©duction de la taille */
}

/* --- Onglets Pop/Rock / Blues --- */

.tabs{
  display:flex;
  gap:12px;
  margin-bottom:12px;
  justify-content:center;
  flex-wrap:wrap;
}

.tab{
  padding:10px 22px;
  background:rgba(15,15,30,0.95);
  border:1px solid #333;
  border-radius:999px;
  color:#bbb;
  cursor:pointer;
  font-weight:600;
  font-size:0.95rem;
  letter-spacing:0.02em;
  transition:.25s;
}

.tab:hover{
  border-color:#4fc3f7;
  color:#fff;
}

.tab.active{
  background:linear-gradient(135deg,#4fc3f7,#00bcd4);
  color:#0b1020;
  border-color:transparent;
  box-shadow:0 4px 18px rgba(79,195,247,0.55);
}

/* --- Contenu des modes --- */

.mode{
  display:none;
  padding:15px;
  background:rgba(0,0,0,0.35);
  border-radius:12px;
  margin-bottom:15px;
}

.mode.active{
  display:block;
}

/* --- Inputs & boutons --- */

.inputs{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
  gap:10px;
  align-items:center;
  margin-bottom:6px;
}

.inputs input,
.inputs select,
.inputs input[type=number]{
  padding:11px 14px;
  background:#161626;
  border:1px solid #333;
  border-radius:12px;
  color:#f5f5f5;
  font-size:0.95rem;
  outline:none;
  min-width:0;
  transition:border-color .2s, box-shadow .2s, background .2s;
}

.inputs select{
  cursor:pointer;
}

.inputs input:focus,
.inputs select:focus{
  border-color:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
  background:#121222;
}

.inputs button{
  padding:11px 20px;
  background:linear-gradient(135deg,#4fc3f7,#00bcd4);
  border:none;
  border-radius:14px;
  color:#021018;
  font-weight:700;
  cursor:pointer;
  font-size:0.95rem;
  letter-spacing:0.03em;
  justify-self:flex-end;
  box-shadow:0 6px 18px rgba(0,0,0,0.7);
  transition:transform .15s, box-shadow .15s, filter .15s;
}

.inputs button:hover{
  filter:brightness(1.06);
  box-shadow:0 8px 22px rgba(0,0,0,0.8);
}

.inputs button:active{
  transform:translateY(1px);
  box-shadow:0 4px 14px rgba(0,0,0,0.6);
}

/* --- Options / cases √† cocher --- */

.options,
.common{
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 6px;
  align-items: start;
  margin: 10px 0;
  padding: 8px;
  background: rgba(0,0,0,0.25);
  border-radius: 8px;
}

/* Premi√®re ligne : Accord actuel, Fret, Vue toggle */
.common > label:nth-of-type(1) { /* Accord actuel */
  grid-column: 1;
  grid-row: 1;
}

.common > label:nth-of-type(2) { /* Fret de d√©part */
  grid-column: 2;
  grid-row: 1;
}

.view-toggle {
  grid-column: 3;
  grid-row: 1;
  justify-self: end;
}

/* Deuxi√®me ligne : Checkboxes compactes */
.common > label:nth-of-type(3), /* Note blue */
.common > label:nth-of-type(4), /* Formes Min7 */
.common > label:nth-of-type(5) { /* Formes Maj7 */
  grid-row: 2;
  font-size: 0.8rem;
}

.common > label:nth-of-type(3) { grid-column: 1; }
.common > label:nth-of-type(4) { grid-column: 2; }
.common > label:nth-of-type(5) { grid-column: 3; }

/* Troisi√®me ligne : Formes longues + BOUTON PORT√âE AU MILIEU */
.common > label:nth-of-type(6) { /* Major (7) / Diminished */
  grid-column: 1;
  grid-row: 3;
  font-size: 0.8rem;
}

.toggle-staff-btn {
  grid-column: 2;
  grid-row: 3;
  justify-self: center;
  margin: 0;
  padding: 6px 16px;
  font-size: 0.85rem;
}

.common > label:nth-of-type(7) { /* Major (7) Blues */
  grid-column: 3;
  grid-row: 3;
  font-size: 0.8rem;
}

/* Sections Gammes et Modes c√¥te √† c√¥te sur ligne 4 */
.scale-modes-section:nth-of-type(1) { /* GAMMES */
  grid-column: 1 / 3;
  grid-row: 4;
}

.scale-modes-section:nth-of-type(2) { /* MODES */
  grid-column: 3;
  grid-row: 4;
}

/* Accord actuel + Fret de d√©part */
.common select,
.common input[type=number]{
  padding:8px 14px;
  background:#101020;
  border:1px solid #252545;
  border-radius:999px;
  color:#f5f5f5;
  font-size:0.9rem;
  min-width:70px;
  outline:none;
  transition:border-color .2s, box-shadow .2s, background .2s;
}

/* focus coh√©rent avec les boutons bleus */
.common select:focus,
.common input[type=number]:focus{
  border-color:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
  background:#121228;
}

/* retire les fl√®ches moches des input[type=number] (Chrome/Edge) */
.common input[type=number]::-webkit-outer-spin-button,
.common input[type=number]::-webkit-inner-spin-button{
  -webkit-appearance:none;
  margin:0;
}

/* Firefox */
.common input[type=number]{
  -moz-appearance:textfield;
}

/* --- Options Blues : checkboxes & select --- */

.options{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  margin:15px 0;
}

/* chaque option devient une petite "pill" sombre */
.options label{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  background:#101020;
  border-radius:999px;
  border:1px solid #252545;
  font-size:0.9rem;
  color:#ddd;
  cursor:pointer;
  user-select:none;
}

/* checkbox custom - taille √©quilibr√©e */
.options input[type=checkbox],
.common input[type=checkbox]{
  width:15px;               /* augmentation 14 ‚Üí 15 */
  height:15px;
  border-radius:3px;
  border:2px solid #4fc3f7;
  background:transparent;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  display:inline-block;
  position:relative;
  cursor:pointer;
  outline:none;
  transition:background .2s, box-shadow .2s, border-color .2s;
  flex-shrink: 0;
}

.options input[type=checkbox]:checked,
.common input[type=checkbox]:checked{
  background:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
}

.options input[type=checkbox]:checked::after,
.common input[type=checkbox]:checked::after{
  content:"";
  position:absolute;
  left:2px;
  top:-1px;
  width:5px;
  height:9px;
  border-right:2px solid #021018;
  border-bottom:2px solid #021018;
  transform:rotate(40deg);
}


/* le select "Style" dans la m√™me logique que les champs communs */
.options select{
  padding:6px 14px;
  background:#101020;
  border:1px solid #252545;
  border-radius:999px;
  color:#f5f5f5;
  font-size:0.9rem;
  outline:none;
  min-width:110px;
  cursor:pointer;
  transition:border-color .2s, box-shadow .2s, background .2s;
}

.options select:focus{
  border-color:#4fc3f7;
  box-shadow:0 0 0 2px rgba(79,195,247,0.35);
  background:#121228;
}


.options label,
.common label{
  font-size:0.95rem;
  color:#ddd;
}

/* --- Boutons de choix (par ex. 5 frettes / 15 frettes) --- */

.view-toggle{
  display:inline-flex;
  align-items:center;
  gap:4px;
  background:#101020;
  border-radius:999px;
  padding:4px;
  border:1px solid #252545;
  margin:10px 0 18px;
}

.view-toggle button{
  border:none;
  background:transparent;
  padding:6px 14px;
  border-radius:999px;
  font-size:0.85rem;
  color:#aaa;
  cursor:pointer;
  transition:.2s;
  white-space:nowrap;
}

.view-toggle button:hover{
  color:#fff;
}

.view-toggle button.active{
  background:linear-gradient(135deg,#4fc3f7,#00bcd4);
  color:#021018;
  box-shadow:0 4px 12px rgba(79,195,247,0.5);
}

/* --- L√©gende --- */
.legend{
  display:flex;
  flex-wrap:nowrap;
  gap:20px;
  margin:0 0 8px;          /* r√©duction drastique des marges */
  overflow-x:auto;
  padding-bottom:4px;
}

/* petit espace au-dessus du manche / port√©e */
#viewWrapper{
  max-width: 900px;
  margin: 4px auto 0;       /* r√©duction de la marge */
}

.legend::-webkit-scrollbar{
  height:6px;
}
.legend::-webkit-scrollbar-track{
  background:transparent;
}
.legend::-webkit-scrollbar-thumb{
  background:#333;
  border-radius:999px;
}

.legend span{
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
  font-size:0.9rem;        /* augmentation 0.85 ‚Üí 0.9 */
}

.dot{
  width:16px;               /* augmentation 14 ‚Üí 16 */
  height:16px;
  border-radius:50%;
  display:inline-block;
}

.dot.chord{background:#aaa}
.dot.root{
  background:#ffeb3b;
  animation:pulse 2s infinite;
}
.dot.target{background:#9b59b6} /* violet pour notes cibles (diff√©rence avec accord pr√©c√©dent) */
.dot.floating{background:#ff9800} /* orange pour notes planantes (approche chromatique) */
.dot.avoid{background:#e53935}
.dot.ok{background:#8bc34a}
.dot.blues{background:#2196f3}
.dot.penta-minor{background:#9c27b0}
.dot.penta-major{background:#ff5722}

/* --- Ligne de notes pour l'accord s√©lectionn√© --- */

.scale-notes {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;                 /* r√©duction du gap */
  margin: 10px 0 14px;      /* + d‚Äôespace sous les bulles */
  font-size: 0.85rem;
}

.scale-notes-label {
  font-weight: 600;
  color: #ddd;
}

.scale-notes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;   /* la suite C D E F G A B centr√©e */
}

/* Centrer la ligne de notes, la l√©gende et les vues manche/port√©e
   sans toucher aux marges haut/bas d√©finies plus haut */
.scale-notes,
.legend,
#viewWrapper {
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
}


/* pastilles de notes (m√™mes couleurs que sur le manche) */
.scale-note{
  padding:6px 14px;
  border-radius:999px;
  font-weight:700;
  font-size:1.05rem;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:40px;
  box-shadow:0 3px 10px rgba(0,0,0,0.6);
}

/* m√™mes couleurs que .note.* */
.scale-note.root{
  background:#ffeb3b;
  color:#000;
}

.scale-note.chord{
  background:#aaa;
  color:#000;
}

.scale-note.ok{
  background:#8bc34a;
  color:#000;
}

.scale-note.target{
  background:#ff9800;
  color:#000;
}

.scale-note.avoid{
  background:#e53935;
  color:#fff;
  opacity:0.85;
}

.scale-note.blues{
  background:#2196f3;
  color:#fff;
}

.scale-note.penta-minor{
  background:#9c27b0;
  color:#fff;
}

.scale-note.penta-major{
  background:#ff5722;
  color:#fff;
}


/* --- Manche de guitare --- */

.fretboard{
  background:rgba(0,0,0,0.5);
  padding:25px;
  border-radius:16px;

  /* r√©duction d‚Äôenviron 15% */
  transform:scale(0.85);
  transform-origin:top center;
  margin:0 auto; /* bien centr√© apr√®s le scale */
}


#fb{
  display:grid;
  grid-template-rows:repeat(6,70px);
  gap:4px;
  background:#111;
  border-radius:12px;
  overflow:hidden;
  padding:10px;
  position:relative;
}

/* 6 cordes dessin√©es sur tout le manche */
#fb::before{
  content:"";
  position:absolute;
  left:10px;
  right:10px;
  top:10px;
  bottom:10px;
  pointer-events:none;

  /* 6 lignes horizontales espac√©es r√©guli√®rement */
  background-image:
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555),
    linear-gradient(to right,#555,#555);
  background-repeat:no-repeat;
  background-size:100% 3px;  /* √©paisseur de la corde */
  background-position:
    0 calc(100% * 1/12),
    0 calc(100% * 3/12),
    0 calc(100% * 5/12),
    0 calc(100% * 7/12),
    0 calc(100% * 9/12),
    0 calc(100% * 11/12);
}


/* cases du manche */
.cell{
  position:relative;
  background:transparent;              /* ne masque plus les cordes */
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:default;
  box-shadow:inset 0 0 0 1px #1a1a1a;  /* pour garder les ‚Äúcases‚Äù visibles */
}



/* Barre de frette pour toutes les colonnes marqu√©es .fret */
.cell.fret::after{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  right:0;            /* barre de frette sur le bord droit de la case */
  width:6px;
  background:#888;
  z-index:1;
}

/* Sillet (frette 0) un peu plus √©pais sur le bord gauche */
.cell.nut::after{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  left:0;
  width:8px;
  background:#aaa;
  z-index:1;
}


/* --- Notes sur le manche --- */

.note{
  width:44px;
  height:44px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:#000;
  background:#333; /* fallback */
  box-shadow:0 4px 15px rgba(0,0,0,0.7);
  position:relative;
  z-index:2;
  transition:transform .15s, box-shadow .15s, background .15s;
  font-size:0.9rem;
}

.note:hover{
  transform:translateY(-1px) scale(1.03);
  box-shadow:0 6px 18px rgba(0,0,0,0.9);
}

/* Tonique en plus gros */
.note.root{
  width:56px;
  height:56px;
  font-size:1.1rem;
  background:#ffeb3b;
  color:#000;
  animation:pulse 2s infinite;
}

/* R√¥le des notes */
.note.chord{
  background:#aaa;
  color:#000;
}

.note.target{
  background:#9b59b6; /* violet pour notes cibles */
  color:#fff;
}

.note.floating{
  background:#ff9800; /* orange pour notes planantes */
  color:#000;
}

.note.ok{
  background:#8bc34a;
  color:#000;
}

.note.blues{
  background:#2196f3;
  color:#fff;
}

.note.penta-minor{
  background:#9c27b0;
  color:#fff;
}

.note.penta-major{
  background:#ff5722;
  color:#fff;
}

/* Formes Min7 / Maj6 / Maj7 / Min6 : accent discret sur les notes du pattern */
.note.shape-min7,
.note.shape-maj6{
  box-shadow:
    0 0 0 2px rgba(255,255,255,0.35),  /* l√©ger anneau clair */
    0 4px 12px rgba(0,0,0,0.85);       /* ombre un peu plus marqu√©e */
}

/* Optionnel : si tu d√©cides d‚Äôafficher les notes √† √©viter */
.note.avoid{
  background:#e53935;
  color:#fff;
  opacity:0.75;
}

/* --- Labels de frettes --- */

#labels{
  display:flex;
  justify-content:space-between;
  margin-top:12px;
  font-size:0.95rem;
  color:#aaa;
  padding:0 15px;
}

#labels div{
  font-size: 1rem;
  font-weight: 600;
}

#labels div.key-fret{
  font-size: 1.2rem;   /* plus gros */
  font-weight: 700;
}

#labels div.octave-fret{
  color: #ffeb3b;      /* d√©j√† dans ton JS avant, on garde l‚Äôid√©e */
}

#startFret option.hot-fret{
  font-weight: 700;
  font-size: 1.05em;   /* un poil plus gros dans la liste */
}


/* Aligner les labels exactement avec les frettes */
#labels{
  display: grid;
  grid-template-columns: repeat(var(--fret-count), 1fr);
  text-align: center;
  margin-top: 12px;
  color:#aaa;
  padding:0 15px;
}


/* --- Message d‚Äôinfo / tonalit√© --- */

.msg{
  font-weight:600;
  color:#4fc3f7;
  margin-top:10px;
}

/* --- Animation pulsation (tonique) --- */

@keyframes pulse{
  0%,100%{box-shadow:0 0 15px #ffeb3b}
  50%{box-shadow:0 0 25px #ffeb3b}
}

/* Tablette */
@media (max-width: 768px) {
  .app{
    margin:10px;
    padding:18px;
  }

  h1{
    font-size:1.6rem;
  }

  .fretboard{
    padding:18px;
    transform:scale(0.8);
  }

  #fb{
    grid-template-rows:repeat(6, 55px); /* moins haut */
  }
}

/* Petit smartphone */
@media (max-width: 480px) {
  .app{
    margin:6px;
    padding:14px;
    border-radius:12px;
  }

  h1{
    font-size:1.3rem;
  }

  .inputs{
    grid-template-columns:1fr; /* 1 colonne pour les accords + bouton */
  }

  .common{
    flex-direction:column;
    align-items:flex-start;
  }

  .fretboard{
    padding:12px;
    transform:scale(0.75);
  }

  #fb{
    grid-template-rows:repeat(6, 45px);
  }

  .note{
    width:38px;
    height:38px;
    font-size:0.8rem;
  }

  .note.root{
    width:48px;
    height:48px;
    font-size:0.95rem;
  }
}

/* ====== STYLES POUR LES GAMMES ET MODES ====== */

/* Sections de gammes/modes - ultra compact */
.scale-modes-section {
  margin: 0;
  padding: 6px 8px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 6px;
  border-left: 2px solid #9c27b0;
}

.scale-modes-section h3 {
  margin: 0 0 4px 0;
  font-size: 0.8rem;       /* augmentation 0.7 ‚Üí 0.8 */
  color: #9c27b0;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.scale-modes-section label {
  display: flex;
  align-items: center;
  gap: 4px;
  margin: 2px 0;
  font-size: 0.8rem;       /* augmentation 0.7 ‚Üí 0.8 */
  color: #ddd;
}

/* Couleur violette pour les notes de gamme / mode */
.note.scale-highlight {
  background: #9c27b0;
  color: #fff;
  box-shadow: 0 4px 15px rgba(156, 39, 176, 0.5);
}

/* Style pour la l√©gende des gammes */
.dot.scale-highlight {
  background: #9c27b0;
}

/* Ajustement de la largeur du fretboard pour 10 et 15 frettes */
.app {
  max-width: 1200px;
  transition: max-width 0.3s ease;
}

/* Largeur √©tendue pour 10 frettes */
.app.frets-10 {
  max-width: 1400px;
}

/* Largeur √©tendue pour 15 frettes */
.app.frets-15 {
  max-width: 1600px;
}

/* Ajustement du centrage pour les vues √©tendues */
.app.frets-10 .scale-notes,
.app.frets-10 .legend,
.app.frets-10 #viewWrapper,
.app.frets-15 .scale-notes,
.app.frets-15 .legend,
.app.frets-15 #viewWrapper {
  max-width: 100%;
}

/* Smartphone portrait */
@media (max-width: 480px) {

  .fretboard{
    padding: 10px;
    transform: none;          /* on enl√®ve le scale fixe */
    margin: 0 auto;
    width: 100%;
  }

  #fb{
    padding: 6px;
    grid-template-rows: repeat(6, 42px); /* hauteur r√©duite */
    gap: 3px;
  }

  /* Cases plus compactes */
  .cell{
    box-shadow: inset 0 0 0 1px #222;
  }

  /* Notes plus petites mais lisibles */
  .note{
    width: 34px;
    height: 34px;
    font-size: 0.75rem;
  }

  .note.root{
    width: 44px;
    height: 44px;
    font-size: 0.85rem;
  }

  /* Labels du bas */
  #labels{
    font-size: 0.8rem;
    padding: 0 8px;
    margin-top: 8px;
  }

  /* Contours / inlays plus fins */
  .cell.fret::after{
    width: 4px;
  }

  .cell.nut::after{
    width: 6px;
  }
}

/* Bouton port√©e */
.toggle-staff-btn {
  padding: 7px 16px;
  border-radius: 12px;
  background: #4fc3f7;
  color: #021018;
  font-weight: 700;
  border: none;
  cursor: pointer;
  box-shadow: 0 5px 12px rgba(0,0,0,.45);
}
.toggle-staff-btn:hover{
  filter: brightness(1.1);
}

/* === Switch propre manche / port√©e === */
#viewWrapper {
  position: relative;
}

/* chaque vue est cach√©e par d√©faut */
.view {
  display: none;
  opacity: 0;
  transition: opacity .25s ease;
}

/* seule la vue active est rendue */
.view.visible {
  display: block;
  opacity: 1;
}

/* Vue port√©e : centr√©e, m√™me largeur que le manche */
#staffView {
  justify-content: center;
  margin-top: 0;
}

/* quand la port√©e est la vue active ‚Üí on l'affiche en flex */
#staffView.visible {
  display: flex;
}

/* Canvas port√©e */
#staffCanvas {
  background: transparent;
  height: 140px;
  max-width: 100%;
}

/* anneau pour les notes de la forme Min7 (penta mineure) */
.note.shape-min7{
  box-shadow: 0 0 0 3px rgba(156,39,176,0.9),
              0 4px 15px rgba(0,0,0,0.7);
}

/* anneau pour les notes de la forme Maj6 / Maj7-Min6 (penta majeure) */
.note.shape-maj6{
  box-shadow: 0 0 0 3px rgba(255,87,34,0.9),
              0 4px 15px rgba(0,0,0,0.7);
}

/* halo particulier pour la blue note si tu veux */
.note.shape-blue{
  box-shadow: 0 0 0 3px rgba(33,150,243,0.95),
              0 4px 15px rgba(0,0,0,0.8);
}

/* formes sur la ligne de notes */
.scale-note.shape-min7{
  position:relative;
  box-shadow:0 0 0 3px rgba(156,39,176,0.95);
}

.scale-note.shape-maj6{
  position:relative;
  box-shadow:0 0 0 3px rgba(255,149,0,0.98);
}

.scale-note.shape-min7.shape-maj6{
  box-shadow:
    0 0 0 3px rgba(156,39,176,0.95),
    0 0 0 6px rgba(255,149,0,0.98);
}

.scale-note.shape-blue{
  position:relative;
  box-shadow:0 0 0 3px rgba(33,150,243,0.98);
}

/* S√©lecteur de chansons personnalis√© */
.song-selector {
  background: linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%);
  border: 2px solid #4a9eff;
  border-radius: 12px;
  padding: 15px;
  color: #ffffff;
  font-family: 'Segoe UI', Arial, sans-serif;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  max-height: 500px;
  overflow-y: auto;
}

.song-list {
  list-style: none;
  padding: 0;
  margin: 0 0 15px 0;
}

.song-group-header {
  font-size: 0.85rem;
  font-weight: 700;
  color: #4fc3f7;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 12px 10px 8px;
  margin-top: 15px;
  border-bottom: 2px solid rgba(79, 195, 247, 0.3);
}

.song-group-header:first-child {
  margin-top: 0;
}

.song-item {
  padding: 12px 15px;
  margin: 5px 0;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-left: 3px solid transparent;
}

.song-item:hover {
  background: rgba(74, 158, 255, 0.2);
  border-left-color: #4a9eff;
  transform: translateX(5px);
}

.song-item.selected {
  background: rgba(74, 158, 255, 0.3);
  border-left-color: #4a9eff;
}

.song-title {
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
}

.song-artist {
  font-size: 12px;
  color: #a0c4e8;
  margin-top: 3px;
}

.song-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  padding-top: 10px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.song-btn {
  padding: 10px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.load-btn {
  background: linear-gradient(135deg, #4fc3f7 0%, #357abd 100%);
  color: #021018;
}

.load-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(74, 158, 255, 0.5);
}

.cancel-btn {
  background: #555;
  color: #fff;
}

.cancel-btn:hover {
  background: #666;
  transform: translateY(-2px);
}

.song-selector::-webkit-scrollbar {
  width: 8px;
}

.song-selector::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

.song-selector::-webkit-scrollbar-thumb {
  background: rgba(74, 158, 255, 0.5);
  border-radius: 4px;
}

.song-selector::-webkit-scrollbar-thumb:hover {
  background: rgba(74, 158, 255, 0.7);
}

/* Selects d'accords - comportement sp√©cial */
.chord-select {
  cursor: pointer;
  position: relative;
}

.chord-select:focus {
  outline: 2px solid #4fc3f7;
}

  </style>
</head>
<body>
  <main class="app">
    <h1>Fretboard Pro</h1>

    <!-- Onglets principaux -->
    <div class="tabs">
      <button class="tab" data-mode="notes">Notes</button>
      <button class="tab active" data-mode="pop">Pop/Rock</button>
      <button class="tab" data-mode="blues">Blues</button>
    </div>

    <!-- === MODE POP/ROCK === -->
    <div class="inputs">
      <!-- Premi√®re ligne : Bouton chanson + accords -->
      <button id="chooseSong">Chanson</button>
      <select id="chord1" class="chord-select"></select>
      <select id="chord2" class="chord-select"></select>
      <select id="chord3" class="chord-select"></select>
      <select id="chord4" class="chord-select"></select>
      <select id="chord5" class="chord-select" style="display:none;"></select>
      <select id="chord6" class="chord-select" style="display:none;"></select>
      <select id="chord7" class="chord-select" style="display:none;"></select>
      <select id="chord8" class="chord-select" style="display:none;"></select>

      <!-- Deuxi√®me ligne : Style + Nombre + Bouton Al√©atoire -->
      <select id="progressionStyle">
        <option value="pop">Pop</option>
        <option value="rock">Rock</option>
        <option value="funk">Funk</option>
      </select>

      <select id="progressionLength">
        <option value="2">2 accords</option>
        <option value="4" selected>4 accords</option>
      </select>

      <button id="generateRandom">Al√©atoire</button>
    </div>

    <!-- Menu des chansons (cach√© par d√©faut) -->
    <div id="songListWrapper" style="display:none; margin: 15px 0;">
      <div class="song-selector">
        <ul class="song-list" id="songList">
          <li class="song-group-header">Ann√©es 60-70</li>
          <li class="song-item" data-song="satisfaction">
            <div class="song-title">Satisfaction</div>
            <div class="song-artist">Rolling Stones</div>
          </li>
          <li class="song-item" data-song="letitbe">
            <div class="song-title">Let It Be</div>
            <div class="song-artist">Beatles</div>
          </li>
          <li class="song-item" data-song="heyjude">
            <div class="song-title">Hey Jude</div>
            <div class="song-artist">Beatles</div>
          </li>
          <li class="song-item" data-song="knockin">
            <div class="song-title">Knockin' on Heaven's Door</div>
            <div class="song-artist">Bob Dylan</div>
          </li>
          <li class="song-item" data-song="standbyme">
            <div class="song-title">Stand By Me</div>
            <div class="song-artist">Ben E. King</div>
          </li>
          <li class="song-item" data-song="wishyou">
            <div class="song-title">Wish You Were Here</div>
            <div class="song-artist">Pink Floyd</div>
          </li>
          <li class="song-item" data-song="california">
            <div class="song-title">Hotel California</div>
            <div class="song-artist">Eagles</div>
          </li>
          <li class="song-item" data-song="sweet">
            <div class="song-title">Sweet Home Alabama</div>
            <div class="song-artist">Lynyrd Skynyrd</div>
          </li>
          <li class="song-item" data-song="imagine">
            <div class="song-title">Imagine</div>
            <div class="song-artist">John Lennon</div>
          </li>
          <li class="song-item" data-song="joker">
            <div class="song-title">The Joker</div>
            <div class="song-artist">Steve Miller Band</div>
          </li>
          <li class="song-item" data-song="wildthing">
            <div class="song-title">Wild Thing</div>
            <div class="song-artist">The Troggs</div>
          </li>
          <li class="song-item" data-song="purplehaze">
            <div class="song-title">Purple Haze</div>
            <div class="song-artist">Jimi Hendrix</div>
          </li>
          <li class="song-item" data-song="sheriff">
            <div class="song-title">I Shot the Sheriff</div>
            <div class="song-artist">Bob Marley</div>
          </li>
          <li class="song-item" data-song="heyjoe">
            <div class="song-title">Hey Joe</div>
            <div class="song-artist">Jimi Hendrix</div>
          </li>

          <li class="song-group-header">Ann√©es 80-90</li>
          <li class="song-item" data-song="everybreath">
            <div class="song-title">Every Breath You Take</div>
            <div class="song-artist">Police</div>
          </li>
          <li class="song-item" data-song="zombie">
            <div class="song-title">Zombie</div>
            <div class="song-artist">Cranberries</div>
          </li>
          <li class="song-item" data-song="withorwithout">
            <div class="song-title">With or Without You</div>
            <div class="song-artist">U2</div>
          </li>
          <li class="song-item" data-song="wonderwall">
            <div class="song-title">Wonderwall</div>
            <div class="song-artist">Oasis</div>
          </li>
          <li class="song-item" data-song="sweetchild">
            <div class="song-title">Sweet Child O' Mine</div>
            <div class="song-artist">Guns N' Roses</div>
          </li>
          <li class="song-item" data-song="shouldistay">
            <div class="song-title">Should I Stay or Should I Go</div>
            <div class="song-artist">Clash</div>
          </li>
          <li class="song-item" data-song="nowoman">
            <div class="song-title">No Woman No Cry</div>
            <div class="song-artist">Bob Marley</div>
          </li>
          <li class="song-item" data-song="losing">
            <div class="song-title">Losing My Religion</div>
            <div class="song-artist">R.E.M.</div>
          </li>
          <li class="song-item" data-song="creep">
            <div class="song-title">Creep</div>
            <div class="song-artist">Radiohead</div>
          </li>
          <li class="song-item" data-song="smells">
            <div class="song-title">Smells Like Teen Spirit</div>
            <div class="song-artist">Nirvana</div>
          </li>
          <li class="song-item" data-song="whatsup">
            <div class="song-title">What's Up</div>
            <div class="song-artist">4 Non Blondes</div>
          </li>
          <li class="song-item" data-song="karma">
            <div class="song-title">Karma Police</div>
            <div class="song-artist">Radiohead</div>
          </li>
          <li class="song-item" data-song="californication">
            <div class="song-title">Californication</div>
            <div class="song-artist">RHCP</div>
          </li>

          <li class="song-group-header">Ann√©es 2000-2020</li>
          <li class="song-item" data-song="baby">
            <div class="song-title">Baby One More Time</div>
            <div class="song-artist">Britney Spears</div>
          </li>
          <li class="song-item" data-song="imyours">
            <div class="song-title">I'm Yours</div>
            <div class="song-artist">Jason Mraz</div>
          </li>
          <li class="song-item" data-song="seven">
            <div class="song-title">Seven Nation Army</div>
            <div class="song-artist">White Stripes</div>
          </li>
          <li class="song-item" data-song="someone">
            <div class="song-title">Someone Like You</div>
            <div class="song-artist">Adele</div>
          </li>
          <li class="song-item" data-song="shallow">
            <div class="song-title">Shallow</div>
            <div class="song-artist">Lady Gaga</div>
          </li>
          <li class="song-item" data-song="riptide">
            <div class="song-title">Riptide</div>
            <div class="song-artist">Vance Joy</div>
          </li>
          <li class="song-item" data-song="shape">
            <div class="song-title">Shape of You</div>
            <div class="song-artist">Ed Sheeran</div>
          </li>
          <li class="song-item" data-song="blinding">
            <div class="song-title">Blinding Lights</div>
            <div class="song-artist">The Weeknd</div>
          </li>
          <li class="song-item" data-song="getlucky">
            <div class="song-title">Get Lucky</div>
            <div class="song-artist">Daft Punk</div>
          </li>

          <li class="song-group-header">Fran√ßais</li>
          <li class="song-item" data-song="jimmy">
            <div class="song-title">Jimmy</div>
            <div class="song-artist">Moriarty</div>
          </li>
        </ul>
        <div class="song-actions">
          <button id="loadSong" class="song-btn load-btn">Charger</button>
          <button id="cancelSong" class="song-btn cancel-btn">Annuler</button>
        </div>
      </div>
    </div>

    <!-- Affichage tonalit√© -->
    <p id="popResult" class="msg"></p>

    <!-- === MODE BLUES === -->
    <div id="bluesMode" class="mode">
      <div class="inputs">
        <label>
          Tonalit√© :
          <select id="bluesKey">
            <option>E</option>
            <option selected>A</option>
            <option>D</option>
            <option>G</option>
            <option>C</option>
            <option>F</option>
            <option>Bb</option>
            <option>Eb</option>
            <option>Ab</option>
            <option>Db</option>
            <option>Gb</option>
            <option>B</option>
          </select>
        </label>
        <span id="bluesGrid" class="msg"></span>
      </div>

      <div class="options">
        <label><input type="checkbox" id="pentaMin" checked> Penta min</label>
        <label><input type="checkbox" id="pentaMaj"> Penta maj</label>
        <label><input type="checkbox" id="bluesNotes" checked> Notes blues</label>
        <label>
          Style :
          <select id="bluesStyle">
            <option value="standard">Standard</option>
            <option value="slow">Slow Blues</option>
          </select>
        </label>
      </div>
    </div>

    <!-- === MODE NOTES === -->
    <div id="notesMode" class="mode">
      <div class="inputs">
        <label>
          Note :
          <select id="noteSel">
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="G">G</option>
            <option value="A">A</option>
            <option value="B">B</option>
          </select>
        </label>
      </div>

      <p class="msg">
        Affiche toutes les positions de la note choisie sur le manche (entre la frette de d√©part et la vue s√©lectionn√©e).
      </p>
    </div>

    <!-- === Zone commune (accord courant / fret / vue) === -->
    <div class="common">
      <label>
        Accord actuel :
        <select id="chordSel"></select>
      </label>

      <label>
        Fret de d√©part :
        <select id="startFret"></select>
      </label>

      <!-- Choix 5 / 8 / 10 / 15 frettes -->
      <div class="view-toggle">
        <button type="button" data-frets="5" class="active">5 frettes</button>
        <button type="button" data-frets="8">8 frettes</button>
        <button type="button" data-frets="10">10 frettes</button>
        <button type="button" data-frets="15">15 frettes</button>
      </div>

      <!-- ‚úÖ case pour afficher la blue note -->
      <label>
        <input type="checkbox" id="showBlueNote">
        Note blue (b5)
      </label>

      <!-- ‚úÖ nouvelles cases pour les formes superpos√©es -->
      <label>
        <input type="checkbox" id="shapeMin7Maj6">
        Formes Min7 / Maj6
      </label>

      <label>
        <input type="checkbox" id="shapeMaj7Min6">
        Formes Maj7 / Min6
      </label>

      <label><input type="checkbox" id="shapeMaj7DimMin6Penta"> Major (7) / Diminished / Minor (6) Pentaphonic</label>

      <label><input type="checkbox" id="shapeMaj7BluesHex"> Major (7) Blues Hexaphonic</label>

      <!-- ‚úÖ NOUVELLES OPTIONS POUR LES GAMMES ET MODES -->
      <div class="scale-modes-section">
        <h3>Gammes</h3>
        <label>
          <input type="checkbox" id="scaleMajor">
          Gamme Majeure
        </label>
        <label>
          <input type="checkbox" id="scaleMinorNatural">
          Gamme Mineure Naturelle
        </label>
        <label>
          <input type="checkbox" id="scaleMinorMelodic">
          Gamme Mineure M√©lodique
        </label>
      </div>

      <div class="scale-modes-section">
        <h3>Modes</h3>
        <label>
          <input type="checkbox" id="modeDorian">
          Dorien
        </label>
        <label>
          <input type="checkbox" id="modeAeolian">
          Aeolien
        </label>
        <label>
          <input type="checkbox" id="modeLydian">
          Lydien
        </label>
      </div>

      <button id="toggleStaff" class="toggle-staff-btn">üéº Port√©e</button>
    </div>

    <!-- ‚úÖ Ligne de notes pour l'accord s√©lectionn√© (centr√©e, AU-DESSUS de la l√©gende) -->
    <div id="scaleNotes" class="scale-notes"></div>

    <!-- L√©gende (toutes les notes sur une ligne, g√©r√© par le CSS) -->
    <div class="legend">
      <span><i class="dot chord"></i>Accord (tonique en gros)</span>
      <span><i class="dot root"></i>Tonique</span>
      <span><i class="dot target"></i>Cible</span>
      <span><i class="dot floating"></i>Note planante</span>
      <span><i class="dot avoid"></i>√Ä √©viter</span>
      <span><i class="dot ok"></i>Dans la gamme</span>
      <span><i class="dot blues"></i>Note blues</span>
      <span><i class="dot penta-minor"></i>Penta min</span>
      <span><i class="dot penta-major"></i>Penta maj</span>
      <!-- entr√©es de l√©gende pour les formes superpos√©es (anneaux) -->
      <span><i class="dot shape-min7"></i>Forme Min7 (calque)</span>
      <span><i class="dot shape-maj6"></i>Forme Maj6 / Maj7-Min6</span>
      <span><i class="dot scale-highlight"></i>Gamme / Mode</span>
    </div>

    <!-- Vues Manche / Port√©e (sans flip 3D) -->
    <div id="viewWrapper">

      <!-- Vue 1 : Manche -->
      <div id="fretView" class="view visible">
        <div class="fretboard">
          <div id="fb"></div>
          <div id="labels"></div>
        </div>
      </div>

      <!-- Vue 2 : Port√©e -->
      <div id="staffView" class="view">
        <canvas id="staffCanvas"></canvas>
      </div>

    </div>

  </main>
  <script>
   // ================== POSITION OPTIMALE DU MANCHE ==================

// Calcule la position de d√©part optimale pour l'improvisation selon la tonalit√©
function getOptimalFretPosition(keyRoot) {
  // On cherche la position de la tonique sur la corde de E grave (corde 6)
  const eStringNote = 4; // La corde E grave = note E = index 4
  
  // Positions de la tonique sur la corde E grave (0-12)
  const positions = [];
  for (let fret = 0; fret <= 12; fret++) {
    const noteAtFret = (eStringNote + fret) % 12;
    if (noteAtFret === keyRoot) {
      positions.push(fret);
    }
  }
  
  // Pour la pentatonique mineure/majeure, la box principale commence 
  // g√©n√©ralement SUR la tonique (pas 2-3 frettes avant)
  // Positions pr√©f√©r√©es : 0, 3, 5, 7, 10, 12
  const preferredPositions = [0, 3, 5, 7, 10, 12];
  
  // On prend la position de la tonique qui est dans les positions pr√©f√©r√©es
  // ou la plus proche
  for (const pos of positions) {
    if (preferredPositions.includes(pos)) {
      return pos;
    }
  }
  
  // Si aucune position exacte, on prend la premi√®re position trouv√©e
  return positions[0] || 0;
}

// ================== CONSTANTES & UTILITAIRES ==================

const NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const STRINGS = ["E","B","G","D","A","E"]; // de la plus grave √† la plus aigu√´
const HOT_FRETS = [3, 5, 7, 9, 12, 15];


// Liste compl√®te des accords de base (chromatisme + variantes)
const CHORD_LIST = [
  "C","C#","D","D#","E","F","F#","G","G#","A","A#","B",
  "Cm","C#m","Dm","D#m","Em","Fm","F#m","Gm","G#m","Am","A#m","Bm",
  "C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7",
  "Cm7","C#m7","Dm7","D#m7","Em7","Fm7","F#m7","Gm7","G#m7","Am7","A#m7","Bm7",
  "Cdim","C#dim","Ddim","D#dim","Edim","Fdim","F#dim","Gdim","G#dim","Adim","A#dim","Bdim"
];

// Base de donn√©es des chansons
const SONGS_DATABASE = {
  satisfaction: { name: "Satisfaction", artist: "Rolling Stones", chords: ["E","D","A","E"] },
  letitbe: { name: "Let It Be", artist: "Beatles", chords: ["C","G","Am","F"] },
  heyjude: { name: "Hey Jude", artist: "Beatles", chords: ["F","C","C7","Bb"] },
  knockin: { name: "Knockin' on Heaven's Door", artist: "Bob Dylan", chords: ["G","D","Am","G"] },
  standbyme: { name: "Stand By Me", artist: "Ben E. King", chords: ["A","F#m","D","E"] },
  wishyou: { name: "Wish You Were Here", artist: "Pink Floyd", chords: ["G","C","D","Am"] },
  california: { name: "Hotel California", artist: "Eagles", chords: ["Bm","F#","A","E","G","D","Em","F#"] },
  sweet: { name: "Sweet Home Alabama", artist: "Lynyrd Skynyrd", chords: ["D","C","G","D"] },
  imagine: { name: "Imagine", artist: "John Lennon", chords: ["C","Cmaj7","F","C"] },
  joker: { name: "The Joker", artist: "Steve Miller Band", chords: ["G","C","D","G"] },
  wildthing: { name: "Wild Thing", artist: "The Troggs", chords: ["A","D","E","D"] },
  purplehaze: { name: "Purple Haze", artist: "Jimi Hendrix", chords: ["E7","G","A","E7"] },
  sheriff: { name: "I Shot the Sheriff", artist: "Bob Marley", chords: ["Gm","Cm","Dm","Gm"] },
  heyjoe: { name: "Hey Joe", artist: "Jimi Hendrix", chords: ["C","G","D","A"] },
  everybreath: { name: "Every Breath You Take", artist: "Police", chords: ["A","F#m","D","E"] },
  zombie: { name: "Zombie", artist: "Cranberries", chords: ["Em","C","G","D"] },
  withorwithout: { name: "With or Without You", artist: "U2", chords: ["D","A","Bm","G"] },
  wonderwall: { name: "Wonderwall", artist: "Oasis", chords: ["Em7","G","Dsus4","A7sus4"] },
  sweetchild: { name: "Sweet Child O' Mine", artist: "Guns N' Roses", chords: ["D","C","G","D"] },
  shouldistay: { name: "Should I Stay or Should I Go", artist: "Clash", chords: ["D","G","A","D"] },
  nowoman: { name: "No Woman No Cry", artist: "Bob Marley", chords: ["C","G","Am","F"] },
  losing: { name: "Losing My Religion", artist: "R.E.M.", chords: ["Am","Em","G","D"] },
  creep: { name: "Creep", artist: "Radiohead", chords: ["G","B","C","Cm"] },
  smells: { name: "Smells Like Teen Spirit", artist: "Nirvana", chords: ["F","Bb","Ab","Db"] },
  whatsup: { name: "What's Up", artist: "4 Non Blondes", chords: ["A","Bm","D","A"] },
  karma: { name: "Karma Police", artist: "Radiohead", chords: ["Am","D","G","Em"] },
  californication: { name: "Californication", artist: "RHCP", chords: ["Am","F","C","G"] },
  baby: { name: "Baby One More Time", artist: "Britney Spears", chords: ["Cm","G","Bb","Ab"] },
  imyours: { name: "I'm Yours", artist: "Jason Mraz", chords: ["G","D","Em","C"] },
  seven: { name: "Seven Nation Army", artist: "White Stripes", chords: ["Em","C","B","Em"] },
  someone: { name: "Someone Like You", artist: "Adele", chords: ["A","E","F#m","D"] },
  shallow: { name: "Shallow", artist: "Lady Gaga", chords: ["Em","D","G","C"] },
  riptide: { name: "Riptide", artist: "Vance Joy", chords: ["Am","G","C","F"] },
  shape: { name: "Shape of You", artist: "Ed Sheeran", chords: ["C#m","F#m","A","B"] },
  blinding: { name: "Blinding Lights", artist: "The Weeknd", chords: ["Fm","Db","Ab","Eb"] },
  getlucky: { name: "Get Lucky", artist: "Daft Punk", chords: ["Bm","D","F#m","E"] },
  jimmy: { name: "Jimmy", artist: "Moriarty", chords: ["Am","F","C","G"] }
};

// Rempli les 8 menus d'accords du mode Pop/Rock
function populateChordDropdowns(){
  ["chord1","chord2","chord3","chord4","chord5","chord6","chord7","chord8"].forEach((id, idx) => {
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.innerHTML = "";
    CHORD_LIST.forEach(ch => sel.add(new Option(ch, ch)));
    // Valeurs par d√©faut : C / G / Am / F / C / G / Am / F
    const defaults = ["C","G","Am","F","C","G","Am","F"];
    sel.value = defaults[idx];
  });
}


// nombre de frettes affich√©es (pilot√© par les boutons 5 / 10 / 15)
let fretCount = 5;

let useFlats = false;          // gestion # / b (pour plus tard)
let currentKeyRoot = 0;        // racine de la tonalit√© courante en mode Pop/Rock
let staffMode = false;         // false = manche, true = port√©e

const MODE_NAMES = ["ionian","dorian","phrygian","lydian","mixolydian","aeolian","locrian"];

// Mod√®les de suites d'accords diatoniques (en degr√©s de gamme majeure)
const PROG_TEMPLATES = {
  pop: {
    2: [
      [1, 5], // I - V
      [6, 4], // vi - IV
      [4, 5]  // IV - V
    ],
    4: [
      [1, 5, 6, 4], // I - V - vi - IV (ultra classique)
      [6, 4, 1, 5], // vi - IV - I - V
      [1, 6, 4, 5], // I - vi - IV - V
      [1, 4, 5, 4]  // I - IV - V - IV
    ]
  },
  rock: {
    2: [
      [1, 4], // I - IV
      [1, 5], // I - V
      [5, 4]  // V - IV
    ],
    4: [
      [1, 4, 5, 4], // I - IV - V - IV
      [1, 5, 4, 5], // I - V - IV - V
      [2, 5, 1, 1], // ii - V - I - I
      [5, 4, 1, 1]  // V - IV - I - I
    ]
  },
  funk: {
    2: [
      [2, 5], // ii - V
      [1, 2]  // I - ii
    ],
    4: [
      [2, 5, 1, 1], // ii - V - I - I
      [2, 5, 6, 6], // ii - V - vi - vi
      [1, 2, 5, 4]  // I - ii - V - IV
    ]
  }
};

// Construit le nom d'accord diatonique (en gamme majeure) pour un degr√© donn√©
function getDiatonicChordName(rootIndex, degree, style = "pop"){
  const scale = majorScale(rootIndex);           // degr√©s 1‚Äì7 en notes
  const noteRoot = scale[degree - 1];            // 0 ‚Üí I, 1 ‚Üí II, etc.
  const noteName = i2n(noteRoot);                // "C", "D", "E", ...

  // Pour le funk, on met un peu plus de 7e
  if(style === "funk"){
    if(degree === 2 || degree === 3 || degree === 6){
      return noteName + "m7";   // ii m7, iii m7, vi m7
    }
    if(degree === 5){
      return noteName + "7";    // V7
    }
    // I, IV, VII : on reste sur triades diatoniques
  }

  // Qualit√© de triade diatonique en gamme MAJEURE : M, m, dim
  const quality = MAJOR_DEG_QUALITIES[degree - 1];

  if(quality === "m")   return noteName + "m";
  if(quality === "dim") return noteName + "dim";
  return noteName; // majeur
}

function generateDiatonicProgression(){
  const styleSel   = document.getElementById("progressionStyle");
  const lengthSel  = document.getElementById("progressionLength");

  const style  = styleSel ? styleSel.value : "pop";
  const length = lengthSel ? parseInt(lengthSel.value, 10) || 4 : 4;

  const templatesByLen = PROG_TEMPLATES[style]?.[length];
  if(!templatesByLen || !templatesByLen.length){
    console.warn("Pas de mod√®le pour ce style/longueur");
    return;
  }

  // Choix d'un mod√®le au hasard parmi ceux disponibles
  const basePattern = templatesByLen[Math.floor(Math.random() * templatesByLen.length)];

  // Si l'utilisateur a demand√© "2 accords", on les r√©p√®te pour remplir les 4 cases
  const fullPattern = (basePattern.length === 2)
    ? basePattern.concat(basePattern)  // ex. [1,5] -> [1,5,1,5]
    : basePattern;

  // Choix d'une tonalit√© majeure au hasard (pour varier un peu)
  const randomRoot = Math.floor(Math.random() * 12); // 0‚Äì11
  currentKeyRoot = randomRoot;                       // pour le manche

  // Conversion des degr√©s en noms d'accords
  const chords = fullPattern.map(deg =>
    getDiatonicChordName(randomRoot, deg, style)
  );

  // Remplit les 4 s√©lecteurs d'accords
  const ids = ["chord1","chord2","chord3","chord4"];
  ids.forEach((id, idx) => {
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.value = chords[idx] || chords[0];
  });

  // Met √† jour la liste d√©roulante "Accord actuel"
  initPopChordSelect();

  // Affiche / met √† jour la tonalit√© et redessine le manche
  // (updatePopKeyFromChords() appelle d√©j√† render())
  updatePopKeyFromChords();
}


function n2i(note){
  note = note.replace("‚ôØ","#").replace("‚ô≠","b");
  if(note.length === 2 && note[1] === "b") {
    return NOTES_FLAT.indexOf(note);
  }
  return NOTES_SHARP.indexOf(note.toUpperCase());
}

function i2n(index){
  return useFlats ? NOTES_FLAT[index % 12] : NOTES_SHARP[index % 12];
}

function parseChord(str){
  str = str.trim();
  const match = str.match(/^([A-G][b#]?)(.*)/i);
  if(!match) {
    return {
      root: 0,
      name: str,
      minor: false,
      dominant7: false,
      dim: false
    };
  }

  const root = match[1];
  const suffix = match[2].toLowerCase();

  // diminu√© (B¬∞, Bdim, Bo‚Ä¶)
  const dim = /dim|¬∞|o/.test(suffix);

  // mineur : m, min, -  (mais PAS maj)
  let minor = false;
  if(!dim){
    if(/^m(?!aj)/.test(suffix) || /min/.test(suffix) || /-/.test(suffix)){
      minor = true;
    }
  }

  // 7 de dominante (A7, D7‚Ä¶) ‚Äì mais pas maj7, ni m7
  const dominant7 = /7/.test(suffix) && !minor && !/maj7/.test(suffix);

  return {
    root: n2i(root),
    name: str,
    minor,
    dominant7,
    dim
  };
}


function majorScale(r){ return [0,2,4,5,7,9,11].map(d => (r+d)%12); }
function pentaMin(r){ return [0,3,5,7,10].map(d => (r+d)%12); }
function pentaMaj(r){ return [0,2,4,7,9].map(d => (r+d)%12); }

// Gamme mineure naturelle (pour tonalit√©s mineures)
function minorScale(r){ return [0,2,3,5,7,8,10].map(d => (r+d)%12); }

// Gamme mineure m√©lodique (ascendante)
// Intervalles : 0, 2, 3, 5, 7, 9, 11
function minorMelodicScale(r){ return [0,2,3,5,7,9,11].map(d => (r+d)%12); }

// Mode Dorien (mode ii de la gamme majeure)
// Intervalles : 0, 2, 3, 5, 7, 9, 10
function dorianScale(r){ return [0,2,3,5,7,9,10].map(d => (r+d)%12); }

// Mode Aeolien (identique √† la gamme mineure naturelle)
// Intervalles : 0, 2, 3, 5, 7, 8, 10
function aeolianScale(r){ return [0,2,3,5,7,8,10].map(d => (r+d)%12); }

// Mode Lydien (mode IV de la gamme majeure)
// Intervalles : 0, 2, 4, 6, 7, 9, 11
function lydianScale(r){ return [0,2,4,6,7,9,11].map(d => (r+d)%12); }


// ===== Major (7) (blues) HEXAPHONIC =====
// Degr√©s : 1, 2, ‚ô≠3, 3, 5, ‚ô≠7
// Intervalles : 0, 2, 3, 4, 7, 10
function major7BluesHex(root){
  const intervals = [0, 2, 3, 4, 7, 10];
  return intervals.map(d => (root + d) % 12);
}

// Blue note sp√©cifique de cette gamme : ‚ô≠3
function major7BluesHexBlue(root){
  return (root + 3) % 12;
}

// ===== Major (7) / Diminished / Minor (6) PENTAPHONIC =====
// Gamme pentaphonique modale : 1, 2, 3, 5, 6
// Intervalles : 0, 2, 4, 7, 9
function maj7DimMin6Penta(root){
  const intervals = [0, 2, 4, 7, 9];
  return intervals.map(d => (root + d) % 12);
}

// Qualit√© attendue des triades dans la gamme MAJEURE : I ii iii IV V vi vii¬∞
const MAJOR_DEG_QUALITIES = ["M","m","m","M","M","m","dim"];


// Qualit√© attendue des triades dans la gamme MINEURE naturelle : i ii¬∞ III iv v VI VII
const MINOR_DEG_QUALITIES = ["m","dim","M","m","m","M","M"];

// Qualit√© de triade √† partir de l'accord pars√©
function triadQualityFromChord(ch){
  if(ch.dim) return "dim";
  if(ch.minor) return "m";
  return "M";
}

// Qualit√© attendue des triades dans le mode DORIEN : i ii III IV v vi¬∞ VII
const DORIAN_DEG_QUALITIES = ["m","m","M","M","m","dim","M"];

// Score d'une tonalit√© pour une liste d'accords (mode configurable)
function scoreDiatonicKey(chords, keyRoot, isMajor = true, scale = null, qualities = null){
  // Si pas de gamme fournie, on utilise majeur ou mineur
  if(!scale){
    scale = isMajor ? majorScale(keyRoot) : minorScale(keyRoot);
  }
  if(!qualities){
    qualities = isMajor ? MAJOR_DEG_QUALITIES : MINOR_DEG_QUALITIES;
  }

  let score = 0;
  let explained = 0;

  chords.forEach((ch, chordIndex) => {
    const idx = scale.indexOf(ch.root);
    if(idx === -1){
      // accord compl√®tement hors de la gamme ‚Üí grosse p√©nalit√©
      score -= 2;
      return;
    }

    explained++;

    const expected = qualities[idx];      // M / m / dim
    const actual = triadQualityFromChord(ch);

    if(actual === expected){
      // accord exactement diatonique au bon degr√©
      score += 5;
    } else if(expected === "dim" && actual === "m"){
      // mineur l√† o√π on attendait diminu√© : pas parfait, mais proche
      score -= 1;
    } else {
      // majeur au lieu de mineur ou l'inverse ‚Üí grosse p√©nalit√©
      score -= 3;
    }

    // bonus pour I / IV / V en majeur, i / iv / v en mineur/dorien
    const isTonicDegree    = (idx === 0);
    const isSubdominant    = (idx === 3);
    const isDominant       = (idx === 4);

    if(!ch.dim){
      if(isMajor && !ch.minor && (isTonicDegree || isSubdominant || isDominant)){
        score += 2;
      }
      if(!isMajor && ch.minor && (isTonicDegree || isSubdominant || isDominant)){
        score += 2;
      }
    }

    // ‚úÖ BONUS IMPORTANT : Le premier accord est souvent la tonique
    if(chordIndex === 0 && isTonicDegree){
      if(actual === expected){
        // Le premier accord est la tonique avec la bonne qualit√© ‚Üí √©norme bonus
        score += 8;
      }
    }
  });

  // bonus si on a clairement l'accord de tonique dans la bonne qualit√©
  const tonicChord = chords.find(ch =>
    ch.root === keyRoot &&
    ((isMajor && !ch.minor && !ch.dim) || (!isMajor && ch.minor && !ch.dim))
  );
  if(tonicChord) score += 3;

  return {score, explained};
}


// Renvoie le nom du mode (ionian, dorian, ...) pour un accord diatonique
function getModeNameForChord(chordRoot, keyRoot){
  const scale = majorScale(keyRoot);
  const idx = scale.indexOf(chordRoot);
  if(idx === -1) return null;
  return MODE_NAMES[idx] || null;
}

// ================== RENDU DU MANCHE ==================

function render(){
  const fb = document.getElementById("fb");
  const labels = document.getElementById("labels");
  const startFret = parseInt(document.getElementById("startFret").value) || 0;

  const activeTab  = document.querySelector(".tab.active");
  const activeMode = activeTab ? activeTab.dataset.mode : "pop";
  const isBluesMode = activeMode === "blues";
  const isNotesMode = activeMode === "notes";

  // En mode Blues, on cache la case "Note blue (b5)" globale (r√©serv√©e au Pop/Rock)
  const globalBlueInput = document.getElementById("showBlueNote");
  const globalBlueLabel = globalBlueInput ? globalBlueInput.parentElement : null;
  if (globalBlueLabel) {
    globalBlueLabel.style.display = isBluesMode ? "none" : "flex";
  }

  // note s√©lectionn√©e en mode NOTES
  const noteSel = document.getElementById("noteSel");
  const noteFilterIdx = (isNotesMode && noteSel) ? n2i(noteSel.value) : null;

  // --- gestion des frettes affich√©es ---
  let localFretCount = fretCount; // valeur par d√©faut (5/10/15)
  let firstFret;

  if (isNotesMode) {
    // MODE NOTES ‚Üí toujours de 1 √† 12
    firstFret = 1;
    localFretCount = 13;
  } else {
    // Pop / Blues ‚Üí centrage du "pattern principal" (box de pentatonique)
    const patternWidth = 5; // startFret -> startFret + 4
    const extra = Math.max(localFretCount - patternWidth, 0);
    const extraBefore = Math.floor(extra / 2);

    firstFret = startFret - extraBefore;
    if (firstFret < 0) firstFret = 0;
  }

  fb.innerHTML = "";
  labels.innerHTML = "";
  fb.style.gridTemplateColumns = `repeat(${localFretCount}, 1fr)`;

  labels.style.setProperty("--fret-count", localFretCount);
  labels.style.gridTemplateColumns = `repeat(${localFretCount}, 1fr)`;

  // racine de tonalit√©
  const keyRoot = isBluesMode
    ? n2i(document.getElementById("bluesKey").value)
    : currentKeyRoot;

  // ‚úÖ IMPORTANT : D√©finir chord AVANT de l'utiliser
  // accord s√©lectionn√© (inutile en mode Notes mais on garde pour r√©utiliser la logique)
  const selectedChordText = document.getElementById("chordSel").value || "C";
  const chord = parseChord(selectedChordText);

  // ‚úÖ Calcul du scaleSet en fonction des options s√©lectionn√©es
  let scaleSet;
  
  // R√©cup√©rer les √©tats des checkboxes
  const scaleMajorCb = document.getElementById("scaleMajor");
  const scaleMinorNaturalCb = document.getElementById("scaleMinorNatural");
  const scaleMinorMelodicCb = document.getElementById("scaleMinorMelodic");
  const modeDorianCb = document.getElementById("modeDorian");
  const modeAeolianCb = document.getElementById("modeAeolian");
  const modeLydianCb = document.getElementById("modeLydian");
  
  // Cr√©er un Set combin√© pour toutes les gammes/modes s√©lectionn√©s
  const combinedScaleSet = new Set();
  
  // Ajouter les notes des gammes s√©lectionn√©es (bas√©es sur chord.root)
  if (scaleMajorCb?.checked) {
    majorScale(chord.root).forEach(n => combinedScaleSet.add(n));
  }
  if (scaleMinorNaturalCb?.checked) {
    minorScale(chord.root).forEach(n => combinedScaleSet.add(n));
  }
  if (scaleMinorMelodicCb?.checked) {
    minorMelodicScale(chord.root).forEach(n => combinedScaleSet.add(n));
  }
  if (modeDorianCb?.checked) {
    dorianScale(chord.root).forEach(n => combinedScaleSet.add(n));
  }
  if (modeAeolianCb?.checked) {
    aeolianScale(chord.root).forEach(n => combinedScaleSet.add(n));
  }
  if (modeLydianCb?.checked) {
    lydianScale(chord.root).forEach(n => combinedScaleSet.add(n));
  }
  
  // Si au moins une gamme/mode est s√©lectionn√©, utiliser le Set combin√©
  // Sinon, utiliser la gamme par d√©faut (blues ou majeure)
  if (combinedScaleSet.size > 0) {
    scaleSet = combinedScaleSet;
  } else if (isBluesMode) {
    scaleSet = new Set(pentaMin(keyRoot)); // en blues on se base sur penta min de la TONALIT√â
  } else {
    scaleSet = new Set(majorScale(keyRoot));
  }

  // notes de l'accord
  const chordNotes = new Set([chord.root]);
  const thirdInterval = (chord.dim || chord.minor) ? 3 : 4;
  const fifthInterval = chord.dim ? 6 : 7;

  chordNotes.add((chord.root + thirdInterval) % 12); // tierce
  chordNotes.add((chord.root + fifthInterval) % 12); // quinte

  if (chord.dominant7 || (chord.minor && /7/.test(chord.name))) {
    chordNotes.add((chord.root + 10) % 12);          // septi√®me mineure
  }

  // ‚úÖ Calcul des notes cibles (notes dans l'accord actuel mais PAS dans l'accord pr√©c√©dent)
  const targetNotes = new Set();
  
  if (!isBluesMode && !isNotesMode) {
    // R√©cup√©rer la liste des accords saisis en mode Pop/Rock
    const chordIds = ["chord1","chord2","chord3","chord4","chord5","chord6","chord7","chord8"];
    const activeChords = chordIds
      .map(id => {
        const el = document.getElementById(id);
        if(!el || el.style.display === 'none') return null;
        return el.value;
      })
      .filter(Boolean);
    
    // Trouver l'index de l'accord actuel
    const currentIndex = activeChords.indexOf(selectedChordText);
    
    if (currentIndex > 0) {
      // Il y a un accord pr√©c√©dent
      const prevChordText = activeChords[currentIndex - 1];
      const prevChord = parseChord(prevChordText);
      
      // Calculer les notes de l'accord pr√©c√©dent
      const prevChordNotes = new Set([prevChord.root]);
      const prevThird = (prevChord.dim || prevChord.minor) ? 3 : 4;
      const prevFifth = prevChord.dim ? 6 : 7;
      
      prevChordNotes.add((prevChord.root + prevThird) % 12);
      prevChordNotes.add((prevChord.root + prevFifth) % 12);
      
      if (prevChord.dominant7 || (prevChord.minor && /7/.test(prevChord.name))) {
        prevChordNotes.add((prevChord.root + 10) % 12);
      }
      
      // Les notes cibles sont celles dans l'accord actuel MAIS PAS dans le pr√©c√©dent
      for (const note of chordNotes) {
        if (!prevChordNotes.has(note)) {
          targetNotes.add(note);
        }
      }
    }
  }

    // === PENTAS, FORMES & NOTES BLUES ===
  const pentaMinCb          = document.getElementById("pentaMin");
  const pentaMajCb          = document.getElementById("pentaMaj");
  const bluesNotesCb        = document.getElementById("bluesNotes");
  const globalBlueCb        = document.getElementById("showBlueNote");
  const shapeMin7Maj6Cb     = document.getElementById("shapeMin7Maj6");
  const shapeMaj7Min6Cb     = document.getElementById("shapeMaj7Min6");
  const shapeMaj7BluesHexCb = document.getElementById("shapeMaj7BluesHex");
  const shapeMaj7DimMin6PentaCb = document.getElementById("shapeMaj7DimMin6Penta");

  // Pentas "classiques" du mode Blues
  const pentaMinBlues  = isBluesMode && (pentaMinCb?.checked ?? false);
  const pentaMajBlues  = isBluesMode && (pentaMajCb?.checked ?? false);
  const showBluesNotes = isBluesMode && (bluesNotesCb?.checked ?? false);

  // Calques de formes (tous modes sauf Notes)
  const useShapeMin7Maj6     = !isNotesMode && (shapeMin7Maj6Cb?.checked ?? false);
  const useShapeMaj7Min6     = !isNotesMode && (shapeMaj7Min6Cb?.checked ?? false);
  const useShapeMaj7DimMin6Penta = !isNotesMode && (shapeMaj7DimMin6PentaCb?.checked ?? false);
  const useShapeMaj7BluesHex = !isNotesMode && (shapeMaj7BluesHexCb?.checked ?? false);

  let shapeMinSet = new Set(); // c√¥t√© "mineur" des formes
  let shapeMajSet = new Set(); // c√¥t√© "majeur" des formes

  // --- Formes Min7 / Maj6 ---
  if (useShapeMin7Maj6) {
    // Min7 : penta mineure sur la tonique de l'accord
    shapeMinSet = new Set(pentaMin(chord.root));

    // Maj6 : penta majeure sur la relative majeure (3 demi-tons au-dessus)
    const relMajRoot = (chord.root + 3) % 12;
    pentaMaj(relMajRoot).forEach(n => shapeMajSet.add(n));
  }

  // --- Formes Maj7 / Min6 ---
  if (useShapeMaj7Min6) {
    // Maj7 : penta majeure sur la tonique de l'accord
    pentaMaj(chord.root).forEach(n => shapeMajSet.add(n));

    // Min6 : penta mineure sur la relative mineure (9 demi-tons au-dessus)
    const relMinRoot = (chord.root + 9) % 12;
    pentaMin(relMinRoot).forEach(n => shapeMinSet.add(n));
  }

  // --- Forme Major7 (blues) HEXAPHONIC ---
  if (useShapeMaj7BluesHex) {
    // 1, 2, ‚ô≠3, 3, 5, 7 + blue note ‚ô≠3
    major7BluesHex(chord.root).forEach(n => shapeMajSet.add(n));
    shapeMajSet.add(major7BluesHexBlue(chord.root));
  }

  // --- Forme Major(7) / Diminished / Minor(6) PENTAPHONIC ---
  if (useShapeMaj7DimMin6Penta) {
    // Gamme pentaphonique modale : 1, 2, 3, 5, 6
    maj7DimMin6Penta(chord.root).forEach(n => shapeMajSet.add(n));
  }


  // --- Formes Min7 / Maj6 ---
  if (useShapeMin7Maj6) {
    // Min7 : penta mineure sur la tonique de l'accord
    shapeMinSet = new Set(pentaMin(chord.root));

    // Maj6 : penta majeure sur la relative majeure (3 demi-tons au-dessus)
    const relMajRoot = (chord.root + 3) % 12;
    pentaMaj(relMajRoot).forEach(n => shapeMajSet.add(n));
  }

  // --- Formes Maj7 / Min6 ---
  if (useShapeMaj7Min6) {
    // Maj7 : penta majeure sur la tonique de l'accord
    pentaMaj(chord.root).forEach(n => shapeMajSet.add(n));

    // Min6 : penta mineure sur la relative mineure (9 demi-tons au-dessus)
    const relMinRoot = (chord.root + 9) % 12;
    pentaMin(relMinRoot).forEach(n => shapeMinSet.add(n));
  }

  // Sets finaux utilis√©s partout (Blues + formes)
  let pentaMinSet = new Set(shapeMinSet);
  let pentaMajSet = new Set(shapeMajSet);

  if (pentaMinBlues) {
    pentaMin(chord.root).forEach(n => pentaMinSet.add(n));
  }
  if (pentaMajBlues) {
    pentaMaj(chord.root).forEach(n => pentaMajSet.add(n));
  }

  // Blue note typique (b5) de l'accord (pour le manche)
  const bluesNote = (chord.root + 6) % 12;

  // üëâ en Blues : checkbox "Notes blues"
  // üëâ en Pop/Rock : checkbox globale "Note blue (b5)"
  const showBlue =
    (isBluesMode && showBluesNotes) ||
    (!isBluesMode && (globalBlueCb?.checked ?? false));

  const bluesSet = showBlue ? new Set([bluesNote]) : new Set();

  const slowBlues = document.getElementById("bluesStyle")?.value === "slow";

    // Quand une forme est active : le "pattern" = union des formes (+ √©ventuelle blue note)
  const shapeActive =
    !isNotesMode && (useShapeMin7Maj6 || useShapeMaj7Min6 || useShapeMaj7BluesHex);

  const patternSet = new Set();
  if (shapeActive) {
    shapeMinSet.forEach(n => patternSet.add(n));
    shapeMajSet.forEach(n => patternSet.add(n));
    if (showBlue) bluesSet.forEach(n => patternSet.add(n));
  }


  // --- Rendu du manche ---
  STRINGS.forEach(openString => {
    const openNoteIdx = n2i(openString);

    for (let f = 0; f < localFretCount; f++) {
      const fretNum = firstFret + f;
      const noteIdx = (openNoteIdx + fretNum) % 12;

      const cell = document.createElement("div");
      cell.className = "cell";

      if (fretNum === 0) {
        cell.classList.add("nut");
      } else {
        cell.classList.add("fret");
      }

      if ([3,5,7,9,15,17,19,21].includes(fretNum)) cell.classList.add("inlay");
      if (fretNum === 12) cell.classList.add("double-inlay");

            let role = null;

      if (isNotesMode) {
        if (noteFilterIdx !== null && noteIdx === noteFilterIdx) {
          role = "root"; // m√™me style que la tonique
        }
      } else if (shapeActive && !patternSet.has(noteIdx)) {
        // Une forme est active ‚Üí on n‚Äôaffiche que les notes du pattern
        role = null;
      } else {
        const intervalFromRoot = (noteIdx - chord.root + 12) % 12;

        const chordToneArray = [...chordNotes];
        const isHalfStepBelowChord = chordToneArray.some(c => (noteIdx + 1) % 12 === c);
        const isHalfStepAboveChord = chordToneArray.some(c => (noteIdx + 11) % 12 === c);

        if (noteIdx === chord.root) {
          role = "root";
        } else if (targetNotes.has(noteIdx)) {
          // ‚úÖ NOTE CIBLE : dans l'accord actuel mais PAS dans le pr√©c√©dent
          role = "target";
        } else if (chordNotes.has(noteIdx)) {
          role = "chord";
        } else if (pentaMinSet.has(noteIdx)) {
          role = "penta-minor";
        } else if (pentaMajSet.has(noteIdx)) {
          role = "penta-major";
        } else if (bluesSet.has(noteIdx)) {
          role = "blues";
        } else if (isBluesMode && slowBlues && [2,5,9].includes(intervalFromRoot)) {
          role = "floating"; // note planante (approche chromatique)
        } else if (!isBluesMode && scaleSet.has(noteIdx)) {
          if (isHalfStepBelowChord) {
            role = "floating"; // note planante (approche chromatique)
          } else if (isHalfStepAboveChord) {
            role = "avoid";
          } else {
            role = "ok";
          }
        } else if (scaleSet.has(noteIdx)) {
          role = "ok";
        } else {
          role = null;
        }
      }
      
      // ‚úÖ AJOUT : V√©rifier si une gamme/mode est s√©lectionn√© et afficher en violet
      const hasScaleModeSelected = 
        (scaleMajorCb?.checked) || 
        (scaleMinorNaturalCb?.checked) || 
        (scaleMinorMelodicCb?.checked) ||
        (modeDorianCb?.checked) || 
        (modeAeolianCb?.checked) || 
        (modeLydianCb?.checked);
      
      // Si une gamme/mode est s√©lectionn√©e et que la note en fait partie
      // on la marque en violet (mais on garde la priorit√© pour les notes d'accord)
      if (hasScaleModeSelected && combinedScaleSet.has(noteIdx) && !role) {
        role = "scale-highlight";
      }

      if (role) {
        const dot = document.createElement("div");
        dot.className = `note ${role}`;
        if (role === "root") dot.classList.add("root");

        // marquer les notes appartenant aux formes (pour un l√©ger style d√©di√©)
        if (!isNotesMode && shapeActive) {
          if (shapeMinSet.has(noteIdx)) dot.classList.add("shape-min7");
          if (shapeMajSet.has(noteIdx)) dot.classList.add("shape-maj6");
        }

        dot.textContent = i2n(openNoteIdx + fretNum);
        cell.appendChild(dot);
      }


      fb.appendChild(cell);
    }
  });

  // --- Labels de frettes ---
  for (let i = 0; i < localFretCount; i++) {
    const num = firstFret + i;
    const div = document.createElement("div");
    div.textContent = num;

    if (HOT_FRETS.includes(num)) {
      div.classList.add("key-fret");
    }
    if (num === 12) {
      div.classList.add("octave-fret");
    }

    labels.appendChild(div);
  }

  // ================== LIGNE DE NOTES ==================
  const scaleNotesEl = document.getElementById("scaleNotes");
  if (scaleNotesEl) {

    // --- mapping anglais -> fran√ßais pour la LIGNE DE NOTES ---
    const FR_NAMES = {
      C: "Do",
      D: "R√©",
      E: "Mi",
      F: "Fa",
      G: "Sol",
      A: "La",
      B: "Si"
    };

    function toFrenchName(eng) {
      if (!eng) return eng;
      const m = eng.match(/^([A-G])([#b]?)/i);
      if (!m) return eng;
      const letter = m[1].toUpperCase();
      const accidental = m[2] || "";
      let base = FR_NAMES[letter] || letter;
      if (accidental === "#") base += "‚ôØ";
      else if (accidental === "b") base += "‚ô≠";
      return base;
    }

    // MODE NOTES ‚Üí affichage simplifi√©
    if (isNotesMode) {
      const noteName = noteSel ? noteSel.value : "C";
      const displayName = staffMode ? toFrenchName(noteName) : noteName;
      scaleNotesEl.innerHTML = `
        <span class="scale-notes-label">Note s√©lectionn√©e :</span>
        <div class="scale-notes-list">
          <span class="scale-note root">${displayName}</span>
        </div>
      `;
      return;
    }

    // Gamme de base : majeure (Pop/Rock) ou penta mineure (Blues)
    let orderedScale = isBluesMode ? pentaMin(keyRoot) : majorScale(keyRoot);

    // on tourne la gamme pour qu'elle commence sur la tonique de l'accord
    const idxInScale = orderedScale.indexOf(chord.root);
    if (idxInScale !== -1) {
      orderedScale = orderedScale
        .slice(idxInScale)
        .concat(orderedScale.slice(0, idxInScale));
    }

    // === INSERTION BLUE NOTE AU MILIEU ===
    // On ins√®re la blue note dans la ligne de notes :
    //   ‚Ä¢ en Pop/Rock ‚Üí si la case "Note blue (b5)" est coch√©e
    //   ‚Ä¢ en Blues    ‚Üí si la case "Notes blues" est coch√©e
    let blueNoteIdx = null;
    let showBlueMid = false;

    if (!isBluesMode && (globalBlueCb?.checked ?? false)) {
      // Pop/Rock : b5 de l'accord courant
      blueNoteIdx = (chord.root + 6) % 12;
      showBlueMid = true;
    } else if (isBluesMode && showBluesNotes) {
      // Blues : b5 de la tonalit√© (toujours la m√™me pour I, IV, V)
      blueNoteIdx = (keyRoot + 6) % 12;
      showBlueMid = true;
    }

    if (showBlueMid && blueNoteIdx !== null) {
      if (!orderedScale.includes(blueNoteIdx)) {
        const blueInt = (blueNoteIdx - chord.root + 12) % 12;
        const intervals = orderedScale.map(n => (n - chord.root + 12) % 12);

        let insertIndex = orderedScale.length;
        for (let i = 0; i < intervals.length - 1; i++) {
          if (intervals[i] <= blueInt && blueInt <= intervals[i + 1]) {
            insertIndex = i + 1;
            break;
          }
        }
        orderedScale.splice(insertIndex, 0, blueNoteIdx);
      }
    }

    // r√¥le des notes (m√™me logique que sur le manche)
    const chordToneArray = [...chordNotes];

    // liste pour la port√©e
    let noteObjects = [];

    const notesHtml = orderedScale.map(noteIdx => {
      let role;
      const intervalFromRoot = (noteIdx - chord.root + 12) % 12;

      const isHalfStepBelowChord = chordToneArray.some(c => (noteIdx + 1) % 12 === c);
      const isHalfStepAboveChord = chordToneArray.some(c => (noteIdx + 11) % 12 === c);

      if (noteIdx === chord.root) {
        role = "root";
      } else if (chordNotes.has(noteIdx)) {
        role = "chord";
      } else if (noteIdx === blueNoteIdx && showBlueMid) {
        role = "blues";
      } else if (pentaMinSet.has(noteIdx)) {
        role = "penta-minor";
      } else if (pentaMajSet.has(noteIdx)) {
        role = "penta-major";
      } else if (!isBluesMode && scaleSet.has(noteIdx)) {
        if (isHalfStepBelowChord) role = "target";
        else if (isHalfStepAboveChord) role = "avoid";
        else role = "ok";
      } else {
        role = "ok";
      }

      const noteName = i2n(noteIdx);                 // notation am√©ricaine
      const displayName = staffMode                 // ce qu'on affiche dans les bulles
        ? toFrenchName(noteName)                    // ‚Üí Do, R√©, Mi‚Ä¶ en MODE PORT√âE
        : noteName;                                 // ‚Üí C, D, E‚Ä¶ en MODE MANCHE

      // pour la port√©e : on garde la note en notation am√©ricaine
      noteObjects.push({ note: noteName, role });

      // classes suppl√©mentaires pour les calques sur la ligne
      let extraClasses = "";
      if (shapeMinSet.has(noteIdx)) extraClasses += " shape-min7";
      if (shapeMajSet.has(noteIdx)) extraClasses += " shape-maj6";
      if (noteIdx === blueNoteIdx && showBlueMid) extraClasses += " shape-blue";

      return `<span class="scale-note ${role}">${displayName}</span>`;

    }).join("");

    const label = `Notes pour ${chord.name} :`;

    scaleNotesEl.innerHTML = `
      <span class="scale-notes-label">${label}</span>
      <div class="scale-notes-list">
        ${notesHtml}
      </div>
    `;

    // Si la port√©e est affich√©e ‚Üí on la met √† jour
    if (staffMode) {
      if (!noteObjects || noteObjects.length === 0) {
        noteObjects = [...chordNotes].map(n => ({
          note: i2n(n),
          role: "chord"
        }));
      }
      renderStaff(noteObjects);
    }
  }
}


// ================== INIT SELECT D'ACCORD POP ==================

populateChordDropdowns();

function initPopChordSelect(){
  const sel = document.getElementById("chordSel");
  if(!sel) return;
  sel.innerHTML = "";
  ["chord1","chord2","chord3","chord4","chord5","chord6","chord7","chord8"].forEach(id => {
    const el = document.getElementById(id);
    if(!el || el.style.display === 'none') return; // Ignorer les selects cach√©s
    const v = el.value.trim();
    if(v) sel.add(new Option(v));
  });
}

// ================== GESTION DES VUES 5 / 10 / 15 FRETTES ==================

const viewButtons = document.querySelectorAll(".view-toggle button");

function setFretsFromButton(btn){
  if(!btn) return;
  const frets = parseInt(btn.dataset.frets, 10) || 15;
  fretCount = frets;
  viewButtons.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  
  // ‚úÖ Ajuster la largeur de l'application selon le nombre de frettes
  const appElement = document.querySelector('.app');
  if (appElement) {
    // Supprimer les classes de largeur existantes
    appElement.classList.remove('frets-10', 'frets-15');
    
    // Ajouter la classe appropri√©e pour 10 ou 15 frettes
    if (frets === 10) {
      appElement.classList.add('frets-10');
    } else if (frets === 15) {
      appElement.classList.add('frets-15');
    }
  }
  
  render();
}

viewButtons.forEach(btn => {
  btn.addEventListener("click", () => setFretsFromButton(btn));
});

// ================== GESTION DES ONGLETS ==================

document.querySelectorAll(".tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".tab, .mode").forEach(el => el.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.mode + "Mode").classList.add("active");

    const mode = tab.dataset.mode;
    const sel = document.getElementById("chordSel");

    if(mode === "blues"){
      // accords I / IV / V dans la tonalit√© choisie
      const key = document.getElementById("bluesKey").value;
      const keyRoot = n2i(key);
      const IV = i2n(keyRoot + 5);
      const V = i2n(keyRoot + 7);

      const chordsForGrid = [`${key}7`, `${IV}7`, `${V}7`];
      document.getElementById("bluesGrid").textContent = "Grille : " + chordsForGrid.join(" - ");

      if(sel){
        sel.innerHTML = "";
        [`${key}7 (I)`, `${IV}7 (IV)`, `${V}7 (V)`].forEach(c => sel.add(new Option(c)));
      }
    } else if (mode === "pop") {
      // mode Pop/Rock ‚Üí on reprend les accords saisis
      initPopChordSelect();
    } else if (mode === "notes") {
      // rien de sp√©cial : le manche d√©pend seulement de noteSel / startFret / vue
    }

    render();
  };
});


function renderStaff(noteObjects) {
  const canvas = document.getElementById("staffCanvas");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  // === largeur de r√©f√©rence ===
  let width = 800;

  // 1) largeur du wrapper (toujours pr√©sent)
  const wrapper = document.getElementById("viewWrapper");
  if (wrapper) {
    const rect = wrapper.getBoundingClientRect();
    if (rect.width > 0) width = rect.width;
  }

  // 2) si le manche est visible, on peut affiner sur #fb
  const fb = document.getElementById("fb");
  if (fb) {
    const r = fb.getBoundingClientRect();
    if (r.width > 0) width = r.width;
  }

  canvas.width = width;
  canvas.height = 140; // port√©e compacte

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // ======== PARAMS G√âN√âRAUX ========
  const top = 30;        // un peu plus haut
  const spacing = 12;    // distance entre les lignes
  const leftMargin = 70; // place pour la cl√© de sol & alt√©rations

  // ======== DESSIN PORT√âE ========
  ctx.strokeStyle = "#eee";
  ctx.lineWidth = 2;

  for (let i = 0; i < 5; i++) {
    const y = top + i * spacing;
    ctx.beginPath();
    ctx.moveTo(leftMargin, y);
    ctx.lineTo(canvas.width - 20, y);
    ctx.stroke();
  }

  // ======== CL√â DE SOL SIMPLE ========
  ctx.fillStyle = "#eee";
  ctx.font = "40px serif";
  try {
    ctx.fillText("ùÑû", 28, top + spacing * 3.7);
  } catch {
    ctx.fillText("G", 28, top + spacing * 3.5);
  }

  // ======== POSITION DE R√âF√âRENCE DES NOTES (cl√© de sol) ========
  const pos = {
    C: top + spacing * 5.5, // Do sous la port√©e
    D: top + spacing * 5,
    E: top + spacing * 4.5,
    F: top + spacing * 4,
    G: top + spacing * 3.5,
    A: top + spacing * 3,
    B: top + spacing * 2.5,
  };

  if (!noteObjects || !noteObjects.length) return;

  const step = (canvas.width - leftMargin - 40) / (noteObjects.length + 1);
  let x = leftMargin + step;

  // noms fran√ßais
  const FR_NAMES = {
    C: "Do",
    D: "R√©",
    E: "Mi",
    F: "Fa",
    G: "Sol",
    A: "La",
    B: "Si"
  };

  // les textes seront centr√©s
  ctx.textAlign = "center";

  noteObjects.forEach(n => {
    const raw = n.note;
    const m = raw.match(/^([A-G])([#b]?)/i);
    const letter = m ? m[1].toUpperCase() : raw[0].toUpperCase();
    const accidental = m && m[2] ? m[2] : null;

    const y = pos[letter] ?? pos.C;

    // --- nom fran√ßais au-dessus de la port√©e ---
    const baseNameFr = FR_NAMES[letter] || letter;
    let label = baseNameFr;
    if (accidental === "#") label += "‚ôØ";
    else if (accidental === "b") label += "‚ô≠";

    ctx.fillStyle = "#eee";
    ctx.font = "14px system-ui, sans-serif";
    ctx.fillText(label, x, top - 6); // au-dessus de la port√©e

    // --- couleur selon le r√¥le ---
    const colorMap = {
      root: "#ffeb3b",
      chord: "#aaaaaa",
      ok: "#8bc34a",
      target: "#ff9800",
      avoid: "#e53935",
      blues: "#2196f3",
      "penta-minor": "#9c27b0",
      "penta-major": "#ff5722"
    };
    const fill = colorMap[n.role] || "#ffffff";

    // Alt√©ration (# / b) √† gauche de la note
    if (accidental) {
      ctx.fillStyle = "#eee";
      ctx.font = "18px serif";
      ctx.fillText(accidental === "#" ? "‚ôØ" : "‚ô≠", x - 18, y + 6);
    }

    // t√™te de note color√©e
    ctx.beginPath();
    ctx.fillStyle = fill;
    ctx.ellipse(x, y, 11, 8, 0, 0, Math.PI * 2);
    ctx.fill();

    x += step;
  });
}



// ================== TONALIT√â POP/ROCK ‚Äî AUTO ==================

// Fonction appel√©e automatiquement d√®s qu'un accord change
function updatePopKeyFromChords() {
  const ids = ["chord1","chord2","chord3","chord4","chord5","chord6","chord7","chord8"];

  const inputs = ids
    .map(id => {
      const el = document.getElementById(id);
      if(!el || el.style.display === 'none') return null;
      return el.value.trim();
    })
    .filter(Boolean);

  const resultEl = document.getElementById("popResult");

  // Aucun accord saisi ‚Üí on efface le message et on sort
  if (!inputs.length) {
    if (resultEl) resultEl.textContent = "";
    return;
  }

  const parsed = inputs.map(parseChord);
  const candidates = [];

  // On teste les 12 tonalit√©s MAJEURES, MINEURES et DORIENNES
  for (let r = 0; r < 12; r++) {
    // MAJEUR
    const maj = scoreDiatonicKey(parsed, r, true);
    if (maj.explained >= 1) {
      candidates.push({
        key: i2n(r),
        mode: "majeur",
        score: maj.score,
        explained: maj.explained
      });
    }

    // MINEUR (gamme mineure naturelle)
    const min = scoreDiatonicKey(parsed, r, false);
    if (min.explained >= 1) {
      candidates.push({
        key: i2n(r) + "m",
        mode: "mineur",
        score: min.score,
        explained: min.explained
      });
    }

    // DORIEN (mode ii - mineur avec 6√®me majeure)
    const dor = scoreDiatonicKey(parsed, r, false, dorianScale(r), DORIAN_DEG_QUALITIES);
    if (dor.explained >= 1) {
      candidates.push({
        key: i2n(r) + "m",
        mode: "dorien",
        score: dor.score,
        explained: dor.explained
      });
    }
  }

  // on trie : meilleur score, puis plus d'accords expliqu√©s, puis majeur avant mineur
  candidates.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    if (b.explained !== a.explained) return b.explained - a.explained;
    if (a.mode !== b.mode) return a.mode === "majeur" ? -1 : 1;
    return 0;
  });

  const best = candidates[0];

  if (best && resultEl) {
    resultEl.textContent =
      `Tonalit√© probable : ${best.key} (${best.mode}) ‚Äì ` +
      `${best.explained}/${inputs.length} accord(s) expliqu√©(s)`;

    // on garde la racine MAJEURE pour l'affichage du manche
    currentKeyRoot = n2i(best.key.replace("m", ""));
    
    // ‚úÖ Positionnement automatique du fret de d√©part optimal
    const optimalFret = getOptimalFretPosition(currentKeyRoot);
    const startFretSelect = document.getElementById("startFret");
    if (startFretSelect) {
      startFretSelect.value = optimalFret;
    }
  } else if (resultEl) {
    resultEl.textContent = "Aucune tonalit√© claire d√©tect√©e";
  }

  // Met √† jour la liste "Accord actuel" avec les accords saisis
  const sel = document.getElementById("chordSel");
  if (sel) {
    sel.innerHTML = "";
    inputs.forEach(ch => sel.add(new Option(ch)));
  }

  render();
}

// Quand un des 8 accords Pop/Rock change ‚Üí recalcul auto de la tonalit√©
["chord1","chord2","chord3","chord4","chord5","chord6","chord7","chord8"].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener("change", updatePopKeyFromChords);
  }
});

// On masque le bouton "Trouver la tonalit√©" (plus besoin)
const findKeyBtn = document.getElementById("findKey");
if (findKeyBtn) {
  findKeyBtn.style.display = "none";
  // Si tu veux garder la possibilit√© de cliquer quand m√™me :
  // findKeyBtn.onclick = updatePopKeyFromChords;
}



// ================== AUTRES √âCOUTEURS ==================

["pentaMin","pentaMaj","bluesNotes","bluesStyle",
 "startFret","chordSel","showBlueNote","noteSel",
 "shapeMin7Maj6","shapeMaj7Min6","shapeMaj7DimMin6Penta","shapeMaj7BluesHex",
 "scaleMajor","scaleMinorNatural","scaleMinorMelodic",
 "modeDorian","modeAeolian","modeLydian"
].forEach(id => {
  const el = document.getElementById(id);
  if(el) el.addEventListener("change", render);
});



// changement de tonalit√© blues ‚Üí met √† jour la grille et les accords
const bluesKeySelect = document.getElementById("bluesKey");
if(bluesKeySelect){
  bluesKeySelect.addEventListener("change", () => {
    const key = bluesKeySelect.value;
    const keyRoot = n2i(key);
    const IV = i2n(keyRoot + 5);
    const V = i2n(keyRoot + 7);

    const chordsForGrid = [`${key}7`, `${IV}7`, `${V}7`];
    document.getElementById("bluesGrid").textContent = "Grille : " + chordsForGrid.join(" - ");

    const sel = document.getElementById("chordSel");
    if(document.querySelector(".tab.active").dataset.mode === "blues" && sel){
      sel.innerHTML = "";
      [`${key}7 (I)`, `${IV}7 (IV)`, `${V}7 (V)`].forEach(c => sel.add(new Option(c)));
    }
    render();
  });
}

// ==== SWITCH MANCHE <-> PORT√âE (sans flip 3D) ====
const fretView = document.getElementById("fretView");
const staffView = document.getElementById("staffView");
const toggleBtn = document.getElementById("toggleStaff");

if (toggleBtn && fretView && staffView) {
  toggleBtn.addEventListener("click", () => {
    staffMode = !staffMode;

    if (staffMode) {
      // Afficher la port√©e
      fretView.classList.remove("visible");
      staffView.classList.add("visible");
      toggleBtn.textContent = "üé∏ Manche";
    } else {
      // Revenir au manche
      staffView.classList.remove("visible");
      fretView.classList.add("visible");
      toggleBtn.textContent = "üéº Port√©e";
    }

    // On redessine tout en fonction du mode courant
    render();
  });
}




// ================== STYLE DES INLAYS ==================

const inlayStyle = document.createElement("style");
inlayStyle.textContent = `
  .inlay::before {
    content:"";
    position:absolute;
    width:12px;
    height:12px;
    background:#666;
    border-radius:50%;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:1;
  }

  /* 12e case : 2 points jaunes bien visibles */
  .double-inlay::before {
    content:"";
    position:absolute;
    width:12px;
    height:12px;
    border-radius:50%;
    background:#ffeb3b;
    top:40%;
    left:50%;
    transform:translateX(-50%);
    z-index:1;
    /* deuxi√®me point en dessous du premier */
    box-shadow:0 18px 0 #666;
  }
`;
document.head.appendChild(inlayStyle);


function initStartFretSelect() {
  const sel = document.getElementById("startFret");
  if (!sel) return;

  sel.innerHTML = "";

  for (let f = 1; f <= 21; f++) {
    const opt = document.createElement("option");
    opt.value = f;
    opt.textContent = f;

    if (HOT_FRETS.includes(f)) {
      opt.classList.add("hot-fret");
    }

    if (f === 5) opt.selected = true; // comme avant
    sel.appendChild(opt);
  }
}


// ================== INITIALISATION ==================

// accords init pour le mode Pop
initPopChordSelect();

// options de frettes de d√©part 1‚Äì21
initStartFretSelect();

// accords init pour le mode Pop
initPopChordSelect();

// vue par d√©faut : 5 frettes pour TOUT (Pop & Blues & Notes)
const defaultBtn5 = document.querySelector('.view-toggle button[data-frets="5"]');
if(defaultBtn5) {
  setFretsFromButton(defaultBtn5);
} else {
  render();
}

// Bouton : g√©n√©ration al√©atoire
const genRandomBtn = document.getElementById("generateRandom");
if(genRandomBtn){
  genRandomBtn.addEventListener("click", generateDiatonicProgression);
}

// Fonction de chargement de chanson
function loadSongChords(){
  const selectedItem = document.querySelector('.song-item.selected');
  if(!selectedItem){
    alert('Veuillez choisir une chanson');
    return;
  }
  
  const songKey = selectedItem.dataset.song;
  if(!songKey || !SONGS_DATABASE[songKey]){
    alert('Chanson invalide');
    return;
  }
  
  const song = SONGS_DATABASE[songKey];
  const ids = ["chord1","chord2","chord3","chord4","chord5","chord6","chord7","chord8"];
  
  // Afficher/masquer les selects en fonction du nombre d'accords
  ids.forEach((id, idx) => {
    const sel = document.getElementById(id);
    if(!sel) return;
    
    if(idx < song.chords.length){
      sel.style.display = '';
      sel.value = song.chords[idx];
    } else {
      sel.style.display = 'none';
      sel.value = song.chords[0]; // valeur par d√©faut
    }
  });
  
  document.getElementById('songListWrapper').style.display = 'none';
  
  initPopChordSelect();
  updatePopKeyFromChords();
  
  const resultEl = document.getElementById("popResult");
  if(resultEl){
    setTimeout(() => {
      resultEl.textContent = `üéµ ${song.name} - ${song.artist}  |  ` + resultEl.textContent;
    }, 100);
  }
}

// Bouton chanson
const chooseSongBtn = document.getElementById("chooseSong");
if(chooseSongBtn){
  chooseSongBtn.addEventListener("click", () => {
    const wrapper = document.getElementById('songListWrapper');
    wrapper.style.display = wrapper.style.display === 'none' ? 'block' : 'none';
  });
}

// Bouton charger
const loadSongBtn = document.getElementById("loadSong");
if(loadSongBtn){
  loadSongBtn.addEventListener("click", loadSongChords);
}

// Bouton annuler
const cancelSongBtn = document.getElementById("cancelSong");
if(cancelSongBtn){
  cancelSongBtn.addEventListener("click", () => {
    document.getElementById('songListWrapper').style.display = 'none';
  });
}

// Gestion de la s√©lection et du double-clic sur la liste des chansons
const songListEl = document.getElementById("songList");
if(songListEl){
  // Gestion de la s√©lection
  songListEl.addEventListener("click", (e) => {
    const item = e.target.closest('.song-item');
    if(!item) return;
    
    // D√©s√©lectionner toutes les chansons
    document.querySelectorAll('.song-item').forEach(el => el.classList.remove('selected'));
    // S√©lectionner la chanson cliqu√©e
    item.classList.add('selected');
  });
  
  // Gestion du double-clic
  songListEl.addEventListener("dblclick", (e) => {
    const item = e.target.closest('.song-item');
    if(!item) return;
    
    // S√©lectionner et charger
    document.querySelectorAll('.song-item').forEach(el => el.classList.remove('selected'));
    item.classList.add('selected');
    loadSongChords();
  });
}

// Calcul initial de la tonalit√© avec les accords par d√©faut
updatePopKeyFromChords();

// Gestion du simple/double clic sur les selects d'accords
document.querySelectorAll('.chord-select').forEach(select => {
  let clickTimer = null;
  
  // Emp√™cher l'ouverture normale du select
  select.addEventListener('mousedown', (e) => {
    if(clickTimer !== null) {
      // Double-clic d√©tect√© - laisser le select s'ouvrir
      clearTimeout(clickTimer);
      clickTimer = null;
      return;
    }
    
    // Premier clic - emp√™cher l'ouverture et d√©marrer le timer
    e.preventDefault();
    
    clickTimer = setTimeout(() => {
      // Simple clic confirm√© - changer l'accord actuel
      const chordSelSelect = document.getElementById('chordSel');
      if(chordSelSelect && select.value) {
        // Trouver l'option correspondante dans chordSel
        for(let i = 0; i < chordSelSelect.options.length; i++) {
          if(chordSelSelect.options[i].value === select.value) {
            chordSelSelect.selectedIndex = i;
            // D√©clencher l'√©v√©nement change pour mettre √† jour l'affichage
            chordSelSelect.dispatchEvent(new Event('change'));
            break;
          }
        }
      }
      clickTimer = null;
    }, 250);
  });
});


  </script>
</body>
</html>
