<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fretboard Pro</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#0d0d0d;color:#eee;font-family:system-ui,sans-serif;}
    .app{max-width:1200px;margin:30px auto;padding:25px;background:rgba(20,20,35,0.95);border-radius:20px;backdrop-filter:blur(15px);box-shadow:0 20px 40px rgba(0,0,0,0.7);}
    h1{text-align:center;margin-bottom:20px;color:#4fc3f7;font-size:2rem;}
    .tabs{display:flex;gap:12px;margin-bottom:20px;justify-content:center;flex-wrap:wrap;}
    .tab{padding:10px 22px;background:rgba(15,15,30,0.95);border:1px solid #333;border-radius:999px;color:#bbb;cursor:pointer;font-weight:600;font-size:0.95rem;letter-spacing:0.02em;transition:.25s;}
    .tab:hover{border-color:#4fc3f7;color:#fff;}
    .tab.active{background:linear-gradient(135deg,#4fc3f7,#00bcd4);color:#0b1020;border-color:transparent;box-shadow:0 4px 18px rgba(79,195,247,0.55);}
    .mode{display:none;padding:15px;background:rgba(0,0,0,0.35);border-radius:12px;margin-bottom:15px;}
    .mode.active{display:block;}
    .inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;align-items:center;margin-bottom:10px;}
    .inputs input,.inputs select,.inputs input[type=number]{padding:11px 14px;background:#161626;border:1px solid #333;border-radius:12px;color:#f5f5f5;font-size:0.95rem;outline:none;min-width:0;transition:border-color .2s, box-shadow .2s, background .2s;}
    .inputs select{cursor:pointer;}
    .inputs input:focus,.inputs select:focus{border-color:#4fc3f7;box-shadow:0 0 0 2px rgba(79,195,247,0.35);background:#121222;}
    .inputs button{padding:11px 20px;background:linear-gradient(135deg,#4fc3f7,#00bcd4);border:none;border-radius:14px;color:#021018;font-weight:700;cursor:pointer;font-size:0.95rem;letter-spacing:0.03em;justify-self:flex-end;box-shadow:0 6px 18px rgba(0,0,0,0.7);transition:transform .15s, box-shadow .15s, filter .15s;}
    .inputs button:hover{filter:brightness(1.06);box-shadow:0 8px 22px rgba(0,0,0,0.8);}
    .inputs button:active{transform:translateY(1px);box-shadow:0 4px 14px rgba(0,0,0,0.6);}
    .options,.common{display:flex;flex-wrap:wrap;gap:15px;align-items:center;margin:15px 0;}
    .options label,.common label{font-size:0.95rem;color:#ddd;}
    .common label{display:flex;align-items:center;gap:8px;}
    .common select,.common input[type=number]{padding:8px 14px;background:#101020;border:1px solid #252545;border-radius:999px;color:#f5f5f5;font-size:0.9rem;min-width:70px;outline:none;transition:border-color .2s, box-shadow .2s, background .2s;}
    .common select:focus,.common input[type=number]:focus{border-color:#4fc3f7;box-shadow:0 0 0 2px rgba(79,195,247,0.35);background:#121228;}
    .common input[type=number]::-webkit-outer-spin-button,.common input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
    .common input[type=number]{-moz-appearance:textfield;}
    .options label{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:#101020;border-radius:999px;border:1px solid #252545;font-size:0.9rem;color:#ddd;cursor:pointer;user-select:none;}
    .options input[type=checkbox],.common input[type=checkbox]{width:16px;height:16px;border-radius:4px;border:2px solid #4fc3f7;background:transparent;appearance:none;display:inline-block;position:relative;cursor:pointer;outline:none;transition:background .2s, box-shadow .2s, border-color .2s;}
    .options input[type=checkbox]:checked,.common input[type=checkbox]:checked{background:#4fc3f7;box-shadow:0 0 0 2px rgba(79,195,247,0.35);}
    .options input[type=checkbox]:checked::after,.common input[type=checkbox]:checked::after{content:"";position:absolute;left:3px;top:0px;width:6px;height:10px;border-right:2px solid #021018;border-bottom:2px solid #021018;transform:rotate(40deg);}
    .options select{padding:6px 14px;background:#101020;border:1px solid #252545;border-radius:999px;color:#f5f5f5;font-size:0.9rem;outline:none;min-width:110px;cursor:pointer;transition:border-color .2s, box-shadow .2s, background .2s;}
    .options select:focus{border-color:#4fc3f7;box-shadow:0 0 0 2px rgba(79,195,247,0.35);background:#121228;}
    .view-toggle{display:inline-flex;align-items:center;gap:4px;background:#101020;border-radius:999px;padding:4px;border:1px solid #252545;margin:10px 0 18px;}
    .view-toggle button{border:none;background:transparent;padding:6px 14px;border-radius:999px;font-size:0.85rem;color:#aaa;cursor:pointer;transition:.2s;white-space:nowrap;}
    .view-toggle button:hover{color:#fff;}
    .view-toggle button.active{background:linear-gradient(135deg,#4fc3f7,#00bcd4);color:#021018;box-shadow:0 4px 12px rgba(79,195,247,0.5);}
    .legend{display:flex;flex-wrap:nowrap;gap:26px;margin:20px 0;overflow-x:auto;padding-bottom:4px;}
    .legend span{display:flex;align-items:center;gap:8px;white-space:nowrap;font-size:0.9rem;}
    .dot{width:16px;height:16px;border-radius:50%;display:inline-block;}
    .dot.chord{background:#aaa}
    .dot.root{background:#ffeb3b;animation:pulse 2s infinite;}
    .dot.target{background:#ff9800}
    .dot.avoid{background:#e53935}
    .dot.ok{background:#8bc34a}
    .dot.blues{background:#2196f3}
    .dot.penta-minor{background:#9c27b0}
    .dot.penta-major{background:#ff5722}
    .fretboard{background:rgba(0,0,0,0.5);padding:25px;border-radius:16px;transform:scale(0.85);transform-origin:top center;margin:0 auto;}
    #fb{display:grid;grid-template-rows:repeat(6,70px);gap:4px;background:#111;border-radius:12px;overflow:hidden;padding:10px;position:relative;}
    #fb::before{content:"";position:absolute;left:10px;right:10px;top:10px;bottom:10px;pointer-events:none;background-image:linear-gradient(to right,#555,#555),linear-gradient(to right,#555,#555),linear-gradient(to right,#555,#555),linear-gradient(to right,#555,#555),linear-gradient(to right,#555,#555),linear-gradient(to right,#555,#555);background-repeat:no-repeat;background-size:100% 3px;background-position:0 calc(100% * 1/12),0 calc(100% * 3/12),0 calc(100% * 5/12),0 calc(100% * 7/12),0 calc(100% * 9/12),0 calc(100% * 11/12);}
    .cell{position:relative;background:transparent;display:flex;align-items:center;justify-content:center;cursor:default;box-shadow:inset 0 0 0 1px #1a1a1a;}
    .cell.fret::after{content:"";position:absolute;top:0;bottom:0;left:50%;width:6px;background:#888;transform:translateX(-50%);z-index:1;}
    .cell.nut::after{content:"";position:absolute;top:0;bottom:0;left:0;width:8px;background:#aaa;z-index:1;}
    .inlay::before{content:"";position:absolute;width:12px;height:12px;background:#666;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1;}
    .double-inlay::before{width:12px;height:36px;border-radius:8px;background:#888;}
    .note{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#000;background:#333;box-shadow:0 4px 15px rgba(0,0,0,0.7);position:relative;z-index:2;transition:transform .15s, box-shadow .15s, background .15s;font-size:0.9rem;}
    .note:hover{transform:translateY(-1px) scale(1.03);box-shadow:0 6px 18px rgba(0,0,0,0.9);}
    .note.root{width:56px;height:56px;font-size:1.1rem;background:#ffeb3b;animation:pulse 2s infinite;}
    .note.chord{background:#aaa;color:#000;}
    .note.target{background:#ff9800;color:#000;}
    .note.ok{background:#8bc34a;color:#000;}
    .note.blues{background:#2196f3;color:#fff;}
    .note.penta-minor{background:#9c27b0;color:#fff;}
    .note.penta-major{background:#ff5722;color:#fff;}
    .note.avoid{background:#e53935;color:#fff;opacity:0.75;}
    #labels{display:flex;justify-content:space-between;margin-top:12px;font-size:0.95rem;color:#aaa;padding:0 15px;}
    .msg{font-weight:600;color:#4fc3f7;margin-top:10px;}
    @keyframes pulse{0%,100%{box-shadow:0 0 15px #ffeb3b}50%{box-shadow:0 0 25px #ffeb3b}}
    @media (max-width: 768px){.app{margin:10px;padding:18px;}h1{font-size:1.6rem;}.fretboard{padding:18px;transform:scale(0.8);}#fb{grid-template-rows:repeat(6,55px);}}
    @media (max-width: 480px){.app{margin:6px;padding:14px;border-radius:12px;}h1{font-size:1.3rem;}.inputs{grid-template-columns:1fr;}.common{flex-direction:column;align-items:flex-start;}.fretboard{padding:10px;transform:none;width:100%;}#fb{padding:6px;grid-template-rows:repeat(6,42px);gap:3px;}.note{width:34px;height:34px;font-size:0.75rem;}.note.root{width:44px;height:44px;font-size:0.9rem;}#labels{font-size:0.8rem;padding:0 8px;margin-top:8px;}.cell.fret::after{width:4px;}.cell.nut::after{width:6px;}}
    /* === SCROLLBARS FINES ET DISCRÈTES – TOUTES LES BARRES (y compris la scrollbar principale) === */

/* WebKit (Chrome, Edge, Safari, Opera) */
html::-webkit-scrollbar,
::-webkit-scrollbar {
  width: 9px;   /* verticale */
  height: 9px;  /* horizontale – rarement visible ici */
}

html::-webkit-scrollbar-track,
::-webkit-scrollbar-track {
  background: transparent;
}

html::-webkit-scrollbar-thumb,
::-webkit-scrollbar-thumb {
  background: rgba(90, 90, 110, 0.65);
  border-radius: 10px;
  border: 2px solid transparent;
  background-clip: content-box;
}

html::-webkit-scrollbar-thumb:hover,
::-webkit-scrollbar-thumb:hover {
  background: rgba(110, 110, 150, 0.85);
  background-clip: content-box;
}

/* Firefox (toutes versions récentes) */
html, * {
  scrollbar-width: thin;
  scrollbar-color: rgba(90, 90, 110, 0.65) transparent;
}
  </style>
</head>
<body>
  <main class="app">
    <h1>Fretboard Pro</h1>

    <div class="tabs">
      <button class="tab active" data-mode="pop">Pop/Rock</button>
      <button class="tab" data-mode="blues">Blues</button>
    </div>

    <div id="popMode" class="mode active">
      <div class="inputs">
        <input id="chord1" value="C" placeholder="Accord 1">
        <input id="chord2" value="G" placeholder="Accord 2">
        <input id="chord3" value="Am" placeholder="Accord 3">
        <input id="chord4" value="F" placeholder="Accord 4">
        <button id="findKey">Trouver la tonalité</button>
      </div>
      <p id="popResult" class="msg"></p>
    </div>

    <div id="bluesMode" class="mode">
      <div class="inputs">
        <label>Tonalité : <select id="bluesKey">
          <option>E</option><option selected>A</option><option>D</option><option>G</option><option>C</option>
          <option>F</option><option>Bb</option><option>Eb</option><option>Ab</option><option>Db</option><option>Gb</option><option>B</option>
        </select></label>
        <span id="bluesGrid" class="msg"></span>
      </div>
      <div class="options">
        <label><input type="checkbox" id="pentaMin" checked> Penta min</label>
        <label><input type="checkbox" id="pentaMaj"> Penta maj</label>
        <label><input type="checkbox" id="bluesNotes" checked> Notes blues</label>
        <label>Style : <select id="bluesStyle">
          <option value="standard">Standard</option>
          <option value="slow">Slow Blues</option>
        </select></label>
      </div>
    </div>

    <div class="common">
      <label>Accord actuel : <select id="chordSel"></select></label>
      <label>Fret de départ : <input id="startFret" type="number" min="0" max="20" value="5"></label>
      <div class="view-toggle">
        <button type="button" data-frets="5" class="active">5 frettes</button>
        <button type="button" data-frets="10">10 frettes</button>
        <button type="button" data-frets="15">15 frettes</button>
      </div>
      <label><input type="checkbox" id="showBlueNote"> Note blue (b5)</label>
    </div>

    <div class="legend">
      <span><i class="dot chord"></i>Accord (tonique en gros)</span>
      <span><i class="dot root"></i>Tonique</span>
      <span><i class="dot target"></i>Cible (slow blues)</span>
      <span><i class="dot avoid"></i>À éviter</span>
      <span><i class="dot ok"></i>Dans la gamme</span>
      <span><i class="dot blues"></i>Note blues</span>
      <span><i class="dot penta-minor"></i>Penta min</span>
      <span><i class="dot penta-major"></i>Penta maj</span>
    </div>

    <div class="fretboard">
      <div id="fb"></div>
      <div id="labels"></div>
    </div>
  </main>

  <script>
    // ================== CONSTANTES & UTILITAIRES ==================
    const NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const NOTES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
    const STRINGS = ["E","B","G","D","A","E"];

    let fretCount = 5;
    let currentKeyRoot = 0;  // Do majeur par défaut

    const MODE_NAMES = ["ionian","dorian","phrygian","lydian","mixolydian","aeolian","locrian"];

    // Choix automatique # ou b selon la tonalité (plus musical)
    function i2n(index){
      const preferFlat = [0, 3, 5, 7, 8, 10]; // C, Eb, F, Ab, Bb, Db
      const useFlats = preferFlat.includes(currentKeyRoot % 12);
      return useFlats ? NOTES_FLAT[index % 12] : NOTES_SHARP[index % 12];
    }

    function n2i(note){
      note = note.replace("♯","#").replace("♭","b").toUpperCase();
      const sharpIdx = NOTES_SHARP.indexOf(note);
      if (sharpIdx !== -1) return sharpIdx;
      return NOTES_FLAT.indexOf(note);
    }

    function parseChord(str){
      str = str.trim();
      const match = str.match(/^([A-G][b#]?)(.*)/i);
      if(!match) return {root:0, name:str, minor:false, dominant7:false};
      const root = match[1];
      const suffix = match[2];
      const minor = /(m|min|-)/i.test(suffix);
      const dominant7 = /7/.test(suffix) && !minor;
      return {root: n2i(root), name: str, minor, dominant7};
    }

    function majorScale(r){ return [0,2,4,5,7,9,11].map(d => (r+d)%12); }
    function naturalMinor(r){ return [0,2,3,5,7,8,10].map(d => (r+d)%12); } // Éolienne
    function pentaMin(r){ return [0,3,5,7,10].map(d => (r+d)%12); }
    function pentaMaj(r){ return [0,2,4,7,9].map(d => (r+d)%12); }

    // ================== RENDU DU MANCHE ==================
    function render(){
      const fb = document.getElementById("fb");
      const labels = document.getElementById("labels");
      if (!fb || !labels) return;

      const startFret = parseInt(document.getElementById("startFret")?.value) || 0;
      const patternWidth = 5;
      const extra = Math.max(fretCount - patternWidth, 0);
      const extraBefore = Math.floor(extra / 2);
      let firstFret = startFret - extraBefore;
      if (firstFret < 0) firstFret = 0;

      fb.innerHTML = "";
      labels.innerHTML = "";
      fb.style.gridTemplateColumns = `repeat(${fretCount}, 1fr)`;

      const isBluesMode = document.querySelector(".tab.active")?.dataset.mode === "blues";
      const keyRoot = isBluesMode ? n2i(document.getElementById("bluesKey")?.value || "A") : currentKeyRoot;

      const chordSel = document.getElementById("chordSel");
      const selectedChordText = chordSel?.value || "C";
      const chord = parseChord(selectedChordText);

      const chordNotes = new Set([chord.root]);
      chordNotes.add((chord.root + (chord.minor ? 3 : 4)) % 12);
      chordNotes.add((chord.root + 7) % 12);
      if(chord.dominant7 || (chord.minor && /7/.test(chord.name))) {
        chordNotes.add((chord.root + 10) % 12);
      }

      const scaleSet = isBluesMode ? new Set(pentaMin(keyRoot)) : new Set(majorScale(keyRoot));

      const showPentaMin = isBluesMode && document.getElementById("pentaMin")?.checked;
      const showPentaMaj = isBluesMode && document.getElementById("pentaMaj")?.checked;
      const showBluesNotes = isBluesMode && document.getElementById("bluesNotes")?.checked;
      const globalBlue = !isBluesMode && document.getElementById("showBlueNote")?.checked;

      const pentaMinSet = showPentaMin ? new Set(pentaMin(chord.root)) : new Set();
      const pentaMajSet = showPentaMaj ? new Set(pentaMaj(chord.root)) : new Set();
      const bluesNote = (chord.root + 6) % 12;
      const bluesSet = (showBluesNotes || globalBlue) ? new Set([bluesNote]) : new Set();

      const slowBlues = document.getElementById("bluesStyle")?.value === "slow";

      STRINGS.forEach(openString => {
        const openNoteIdx = n2i(openString);
        for(let f = 0; f < fretCount; f++){
          const fretNum = firstFret + f;
          const noteIdx = (openNoteIdx + fretNum) % 12;

          const cell = document.createElement("div");
          cell.className = "cell";
          if(fretNum === 0) cell.classList.add("nut");
          else cell.classList.add("fret");
          if([3,5,7,9,15,17,19,21].includes(fretNum)) cell.classList.add("inlay");
          if(fretNum === 12) cell.classList.add("double-inlay");

          let role = null;
          const intervalFromRoot = (noteIdx - chord.root + 12) % 12;

          if(noteIdx === chord.root) role = "root";
          else if(chordNotes.has(noteIdx)) role = "chord";
          else if(pentaMinSet.has(noteIdx)) role = "penta-minor";
          else if(pentaMajSet.has(noteIdx)) role = "penta-major";
          else if(bluesSet.has(noteIdx)) role = "blues";
          else if(isBluesMode && slowBlues && [2,5,9].includes(intervalFromRoot)) role = "target";
          else if(!isBluesMode && scaleSet.has(noteIdx)){
            const isHalfStepBelow = [...chordNotes].some(c => (noteIdx + 1) % 12 === c);
            const isHalfStepAbove = [...chordNotes].some(c => (noteIdx + 11) % 12 === c);
            role = isHalfStepBelow ? "target" : (isHalfStepAbove ? "avoid" : "ok");
          }
          else if(scaleSet.has(noteIdx)) role = "ok";

          if(role){
            const dot = document.createElement("div");
            dot.className = `note ${role}`;
            if(role === "root") dot.classList.add("root");
            dot.textContent = i2n(openNoteIdx + fretNum);
            cell.appendChild(dot);
          }
          fb.appendChild(cell);
        }
      });

      for(let i = 0; i < fretCount; i++){
        const num = firstFret + i;
        const div = document.createElement("div");
        div.textContent = num;
        if([3,5,7,9,12,15].includes(num)) div.style.fontWeight = "bold";
        if(num === 12) div.style.color = "#ffeb3b";
        labels.appendChild(div);
      }
    }

    // ================== INITIALISATION SELECT ACCORDS ==================
    function initPopChordSelect(){
      const sel = document.getElementById("chordSel");
      if(!sel) return;
      sel.innerHTML = "";
      ["chord1","chord2","chord3","chord4"].forEach(id => {
        const v = document.getElementById(id)?.value.trim();
        if(v) sel.add(new Option(v));
      });
    }

    // ================== GESTION DES BOUTONS 5/10/15 ==================
    document.querySelectorAll(".view-toggle button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".view-toggle button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        fretCount = parseInt(btn.dataset.frets);
        render();
      });
    });

    // ================== ONGLETS POP / BLUES ==================
    document.querySelectorAll(".tab").forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll(".tab, .mode").forEach(el => el.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.mode + "Mode").classList.add("active");

        const sel = document.getElementById("chordSel");
        if(!sel) return;

        if(tab.dataset.mode === "blues"){
          const key = document.getElementById("bluesKey")?.value || "A";
          const keyRoot = n2i(key);
          const IV = i2n(keyRoot + 5);
          const V = i2n(keyRoot + 7);
          document.getElementById("bluesGrid").textContent = `Grille : ${key}7 - ${IV}7 - ${V}7`;

          sel.innerHTML = "";
          [`${key}7 (I)`, `${IV}7 (IV)`, `${V}7 (V)`].forEach(c => sel.add(new Option(c)));
        } else {
          initPopChordSelect();
        }
        render();
      };
    });

    // ================== TROUVER LA TONALITÉ ==================
    document.getElementById("findKey")?.addEventListener("click", () => {
      const inputs = ["chord1","chord2","chord3","chord4"]
        .map(id => document.getElementById(id)?.value.trim())
        .filter(Boolean);

      if(inputs.length < 2){
        alert("Entrez au moins 2 accords");
        return;
      }

      const parsed = inputs.map(parseChord);
      const candidates = [];

      for(let r = 0; r < 12; r++){
        const maj = majorScale(r);
        const min = naturalMinor(r);

        const scoreMaj = parsed.filter(c => maj.includes(c.root)).length;
        const scoreMin = parsed.filter(c => min.includes(c.root)).length;

        if(scoreMaj >= 3) candidates.push({key: i2n(r), mode:"majeur", score:scoreMaj});
        if(scoreMin >= 3) candidates.push({key: i2n(r)+"m", mode:"mineur", score:scoreMin});
      }

      const best = candidates.sort((a,b)=>b.score-a.score)[0];
      const resultEl = document.getElementById("popResult");

      if(best){
        resultEl.textContent = `Tonalité probable : ${best.key} (${best.mode}) – ${best.score}/4 accords expliqués`;
        currentKeyRoot = n2i(best.key.replace("m",""));
        initPopChordSelect();
      } else {
        resultEl.textContent = "Aucune tonalité claire détectée";
      }
      render();
    });

    // ================== ÉCOUTEURS GÉNÉRAUX ==================
    ["pentaMin","pentaMaj","bluesNotes","bluesStyle","startFret","chordSel","showBlueNote","bluesKey"].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.addEventListener("change", render);
    });

    // Mise à jour grille blues au changement de tonalité
    document.getElementById("bluesKey")?.addEventListener("change", function(){
      const key = this.value;
      const keyRoot = n2i(key);
      const IV = i2n(keyRoot + 5);
      const V = i2n(keyRoot + 7);
      document.getElementById("bluesGrid").textContent = `Grille : ${key}7 - ${IV}7 - ${V}7`;

      const sel = document.getElementById("chordSel");
      if(sel && document.querySelector(".tab.active")?.dataset.mode === "blues"){
        sel.innerHTML = "";
        [`${key}7 (I)`, `${IV}7 (IV)`, `${V}7 (V)`].forEach(c => sel.add(new Option(c)));
      }
      render();
    });

    // ================== INITIALISATION ==================
    initPopChordSelect();
    render();
  </script>
</body>
</html>
